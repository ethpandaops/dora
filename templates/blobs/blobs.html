{{ define "page" }}
<div class="container mt-2">
  <div class="d-md-flex py-2 justify-content-md-between">
    <h1 class="h4 mb-1 mb-md-0"><i class="fas fa-database mx-2"></i>Blobs</h1>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb font-size-1 mb-0" style="padding:0; background-color:transparent;">
        <li class="breadcrumb-item"><a href="/" title="Home">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">Blobs</li>
      </ol>
    </nav>
  </div>

  <div class="card mt-4">
    <div class="card-header">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Time-Based Statistics</h5>
        <div class="btn-group" role="group">
          <input type="radio" class="btn-check" name="timePeriod" id="time1h" value="1h">
          <label class="btn btn-outline-primary btn-sm" for="time1h">1h</label>

          <input type="radio" class="btn-check" name="timePeriod" id="time1d" value="1d" checked>
          <label class="btn btn-outline-primary btn-sm" for="time1d">1d</label>

          <input type="radio" class="btn-check" name="timePeriod" id="time7d" value="7d">
          <label class="btn btn-outline-primary btn-sm" for="time7d">7d</label>

          <input type="radio" class="btn-check" name="timePeriod" id="time18d" value="18d">
          <label class="btn btn-outline-primary btn-sm" for="time18d">18d</label>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3 mb-3">
          <div class="p-3 bg-primary bg-opacity-10 rounded border border-primary text-center">
            <small class="text-muted d-block mb-1">Total Blobs</small>
            <div class="fs-4 fw-bold text-primary" id="timeBlobs">{{ formatAddCommas .BlobsLast24h }}</div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="p-3 bg-info bg-opacity-10 rounded border border-info text-center">
            <small class="text-muted d-block mb-1">Blocks with Blobs</small>
            <div class="fs-4 fw-bold text-info" id="timeBlocksWithBlobs">-</div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="p-3 bg-success bg-opacity-10 rounded border border-success text-center">
            <small class="text-muted d-block mb-1">Avg Blobs/Block</small>
            <div class="fs-4 fw-bold text-success" id="timeAvgBlobs">-</div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="p-3 bg-warning bg-opacity-10 rounded border border-warning text-center">
            <small class="text-muted d-block mb-1">Avg Blob Gas/Block</small>
            <div class="fs-4 fw-bold text-warning" id="timeAvgGas">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mt-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="fas fa-calculator"></i> Blob Storage Calculator (PeerDAS)</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-12">
          <div class="mb-4">
            <label for="ethSlider" class="form-label">
              <span>ETH Staked:</span>
            </label>
            <div class="row g-3 align-items-center mb-2">
              <div class="col-md-9">
                <input type="range" class="form-range" id="ethSlider"
                       min="{{ .StorageCalculator.MinEth }}"
                       max="{{ .StorageCalculator.MaxEth }}"
                       value="{{ .StorageCalculator.DefaultEth }}"
                       step="32">
              </div>
              <div class="col-md-3">
                <div class="input-group">
                  <input type="number" class="form-control" id="ethInput"
                         min="{{ .StorageCalculator.MinEth }}"
                         max="{{ .StorageCalculator.MaxEth }}"
                         value="{{ .StorageCalculator.DefaultEth }}"
                         step="1">
                  <span class="input-group-text">ETH</span>
                </div>
              </div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              <div class="p-3 bg-primary bg-opacity-10 rounded border border-primary">
                <small class="text-muted d-block mb-1">Validators</small>
                <div class="fs-4 fw-bold text-primary" id="validatorsCount">8</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="p-3 bg-info bg-opacity-10 rounded border border-info">
                <small class="text-muted d-block mb-1">Custody Columns</small>
                <div class="fs-4 fw-bold text-info" id="custodyColumns">8</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="p-3 bg-success bg-opacity-10 rounded border border-success">
                <small class="text-muted d-block mb-1">Custody %</small>
                <div class="fs-4 fw-bold text-success" id="custodyPercent">6.25%</div>
              </div>
            </div>
          </div>

          <div class="alert alert-success p-4 text-center border-2">
            <h4 class="mb-2 text-success">Current Storage Required</h4>
            <h1 class="mb-0 display-4 fw-bold text-success" id="storageResult">Loading...</h1>
            <small class="text-muted d-block mt-2" id="storageDescription">Based on {{ formatAddCommas .BlobsLast18d }} blobs in last 18d</small>
          </div>

          <div class="mt-3">
            <h6 class="d-inline-flex align-items-center">
              How it works:
              <a href="#" class="ms-2 text-decoration-none" data-bs-toggle="collapse" data-bs-target="#howItWorksCollapse" aria-expanded="false" aria-controls="howItWorksCollapse">
                <i class="fas fa-question-circle text-muted"></i>
              </a>
            </h6>
            <div class="collapse" id="howItWorksCollapse">
              <ul class="small mb-0 mt-2">
                <li>Non-validating nodes (0 ETH): <strong>{{ .StorageCalculator.CustodyRequirement }} columns minimum</strong></li>
                <li>Validating nodes ({{ .StorageCalculator.MaxEffectiveBalanceEth }}-{{ mul .StorageCalculator.ValidatorCustodyRequirement .StorageCalculator.MaxEffectiveBalanceEth }} ETH): <strong>{{ .StorageCalculator.ValidatorCustodyRequirement }} columns (free threshold)</strong></li>
                <li>{{ mul .StorageCalculator.ValidatorCustodyRequirement .StorageCalculator.MaxEffectiveBalanceEth }}-{{ .StorageCalculator.MaxEth }} ETH: <strong>+1 column per additional {{ .StorageCalculator.MaxEffectiveBalanceEth }} ETH</strong></li>
                <li>{{ .StorageCalculator.MaxEth }}+ ETH: <strong>{{ .StorageCalculator.TotalColumns }} columns (full custody)</strong></li>
                <li>Blob retention: <strong>{{ .StorageCalculator.MinEpochsForBlobSidecarsRequests }} epochs (~18 days)</strong></li>
                <li>Blobs are erasure coded: <strong>128 KiB → 256 KiB ({{ .StorageCalculator.TotalColumns }} columns × {{ div .StorageCalculator.ColumnSizeBytes 1024 }} KiB each)</strong></li>
                <li>Storage per blob: <strong>{{ div .StorageCalculator.ColumnSizeBytes 1024 }} KiB × columns custodied</strong></li>
              </ul>
              <p class="small text-muted mt-2 mb-0">
                Learn more: <a href="https://ethereum.org/roadmap/fusaka/#peerdas" target="_blank" rel="noopener">PeerDAS on ethereum.org</a>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {{ if .LatestBlobBlocks }}
  <div class="card mt-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="fas fa-list"></i> Latest Blob Transactions</h5>
    </div>
    <div class="card-body px-0 py-3">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th>Slot</th>
              <th>Block Number</th>
              <th>Time</th>
              <th>Blob Count</th>
              <th>Proposer</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {{ range $i, $block := .LatestBlobBlocks }}
            <tr>
              <td><a href="/slot/{{ $block.Slot }}">{{ formatAddCommas $block.Slot }}</a></td>
              <td>{{ ethBlockLink $block.BlockNumber }}</td>
              <td data-timer="{{ $block.Timestamp.Unix }}">
                <span data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{{ $block.Timestamp }}">
                  {{ formatRecentTimeShort $block.Timestamp }}
                </span>
              </td>
              <td>
                <span class="badge rounded-pill text-bg-primary">{{ $block.BlobCount }}</span>
              </td>
              <td>{{ formatValidator $block.Proposer $block.ProposerName }}</td>
              <td>
                {{ if $block.Finalized }}
                <span class="badge rounded-pill text-bg-success">Finalized</span>
                {{ else }}
                <span class="badge rounded-pill text-bg-warning">Non-finalized</span>
                {{ end }}
              </td>
            </tr>
            {{ end }}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {{ end }}

  <div id="footer-placeholder" style="height:71px;"></div>
</div>
{{ end }}

{{ define "js" }}
<script type="text/javascript">
const RETENTION_EPOCHS = {{ .StorageCalculator.MinEpochsForBlobSidecarsRequests }};
const SLOTS_PER_EPOCH = {{ .StorageCalculator.SlotsPerEpoch }};
const RETENTION_SLOTS = RETENTION_EPOCHS * SLOTS_PER_EPOCH;
const COLUMN_SIZE_BYTES = {{ .StorageCalculator.ColumnSizeBytes }};
const TOTAL_COLUMNS = {{ .StorageCalculator.TotalColumns }};
const MAX_EFFECTIVE_BALANCE_ETH = {{ .StorageCalculator.MaxEffectiveBalanceEth }};
const CUSTODY_REQUIREMENT = {{ .StorageCalculator.CustodyRequirement }};
const VALIDATOR_CUSTODY_REQUIREMENT = {{ .StorageCalculator.ValidatorCustodyRequirement }};
const FREE_THRESHOLD_ETH = VALIDATOR_CUSTODY_REQUIREMENT * MAX_EFFECTIVE_BALANCE_ETH;
const MAX_ETH = {{ .StorageCalculator.MaxEth }};

const blobsInRetentionWindow = {{ .BlobsLast18d }};
const blobsLast24h = {{ .BlobsLast24h }};
const blobsLast7d = {{ .BlobsLast7d }};
const blobsLast18d = {{ .BlobsLast18d }};

const timeStats = {
  '1h': {
    blobs: {{ .BlobsLast1h }},
    blocksWithBlobs: {{ .BlocksWithBlobsLast1h }},
    blobGas: {{ .BlobGasLast1h }},
    label: '1h'
  },
  '1d': {
    blobs: {{ .BlobsLast24h }},
    blocksWithBlobs: {{ .BlocksWithBlobsLast24h }},
    blobGas: {{ .BlobGasLast24h }},
    label: '1d'
  },
  '7d': {
    blobs: {{ .BlobsLast7d }},
    blocksWithBlobs: {{ .BlocksWithBlobsLast7d }},
    blobGas: {{ .BlobGasLast7d }},
    label: '7d'
  },
  '18d': {
    blobs: {{ .BlobsLast18d }},
    blocksWithBlobs: {{ .BlocksWithBlobsLast18d }},
    blobGas: {{ .BlobGasLast18d }},
    label: '18d'
  }
};

let currentPeriod = '1d';
let currentBlobCount = {{ .BlobsLast24h }};
const calculatorBlobCount = {{ .BlobsLast18d }};

function updateTimeStats(period) {
  const stats = timeStats[period];
  const blobs = stats.blobs;
  const blocks = stats.blocksWithBlobs;
  const gas = stats.blobGas;

  currentPeriod = period;
  currentBlobCount = blobs;

  document.getElementById('timeBlobs').textContent = blobs.toLocaleString();
  document.getElementById('timeBlocksWithBlobs').textContent = blocks.toLocaleString();

  const avgBlobs = blocks > 0 ? (blobs / blocks).toFixed(2) : '0.00';
  document.getElementById('timeAvgBlobs').textContent = avgBlobs;

  const avgGas = blocks > 0 ? Math.round(gas / blocks).toLocaleString() : '0';
  document.getElementById('timeAvgGas').textContent = avgGas;
}

function calculateCustodyColumns(eth) {
  if (eth === 0) {
    return CUSTODY_REQUIREMENT;
  } else if (eth < MAX_EFFECTIVE_BALANCE_ETH) {
    return CUSTODY_REQUIREMENT;
  } else if (eth <= FREE_THRESHOLD_ETH) {
    return VALIDATOR_CUSTODY_REQUIREMENT;
  } else if (eth <= MAX_ETH) {
    return VALIDATOR_CUSTODY_REQUIREMENT + Math.floor((eth - FREE_THRESHOLD_ETH) / MAX_EFFECTIVE_BALANCE_ETH);
  } else {
    return TOTAL_COLUMNS;
  }
}

function calculateStorage(eth) {
  const validators = Math.floor(eth / MAX_EFFECTIVE_BALANCE_ETH);
  const columns = calculateCustodyColumns(eth);
  const custodyPercent = ((columns / TOTAL_COLUMNS) * 100).toFixed(2);

  const blobsToStore = calculatorBlobCount > 0 ? calculatorBlobCount : 0;

  const storageBytes = blobsToStore * columns * COLUMN_SIZE_BYTES;
  const storageKiB = storageBytes / 1024;
  const storageMiB = storageKiB / 1024;
  const storageGiB = storageMiB / 1024;
  const storageTiB = storageGiB / 1024;

  return {
    validators: validators,
    columns: columns,
    custodyPercent: custodyPercent,
    storageGiB: storageGiB.toFixed(2),
    storageTiB: storageTiB.toFixed(3),
    storageMiB: storageMiB.toFixed(2)
  };
}

function updateCalculator(ethValue, fromSlider) {
  if (ethValue === undefined) {
    ethValue = parseInt(document.getElementById('ethSlider').value);
  }

  ethValue = Math.max({{ .StorageCalculator.MinEth }}, Math.min({{ .StorageCalculator.MaxEth }}, ethValue));

  if (fromSlider) {
    ethValue = Math.round(ethValue / 32) * 32;
  }

  if (fromSlider) {
    document.getElementById('ethInput').value = ethValue;
  }
  document.getElementById('ethSlider').value = Math.round(ethValue / 32) * 32;

  const result = calculateStorage(ethValue);

  document.getElementById('validatorsCount').textContent = result.validators;
  document.getElementById('custodyColumns').textContent = result.columns + ' / ' + TOTAL_COLUMNS;
  document.getElementById('custodyPercent').textContent = result.custodyPercent + '%';

  let storageText;
  if (parseFloat(result.storageMiB) < 1024) {
    storageText = result.storageMiB + ' MiB';
  } else if (parseFloat(result.storageGiB) < 1024) {
    storageText = result.storageGiB + ' GiB';
  } else {
    storageText = result.storageTiB + ' TiB';
  }

  document.getElementById('storageResult').textContent = storageText;

  const descText = 'Based on ' + calculatorBlobCount.toLocaleString() + ' blobs in last 18d';
  document.getElementById('storageDescription').textContent = descText;
}

document.addEventListener('DOMContentLoaded', function() {
  const ethSlider = document.getElementById('ethSlider');
  const ethInput = document.getElementById('ethInput');

  ethSlider.addEventListener('input', function() {
    updateCalculator(parseInt(this.value), true);
  });

  ethInput.addEventListener('input', function() {
    let value = parseInt(this.value);
    if (!isNaN(value)) {
      updateCalculator(value, false);
    }
  });

  ethInput.addEventListener('blur', function() {
    let value = parseInt(this.value);
    if (isNaN(value) || value < {{ .StorageCalculator.MinEth }}) {
      value = {{ .StorageCalculator.MinEth }};
    } else if (value > {{ .StorageCalculator.MaxEth }}) {
      value = {{ .StorageCalculator.MaxEth }};
    }
    this.value = value;
    updateCalculator(value, false);
  });

  const timePeriodRadios = document.querySelectorAll('input[name="timePeriod"]');
  timePeriodRadios.forEach(function(radio) {
    radio.addEventListener('change', function() {
      updateTimeStats(this.value);
    });
  });

  updateCalculator(undefined, true);
  updateTimeStats('1d');
});
</script>
{{ end }}

{{ define "css" }}
<style>
  .stat-card {
    transition: transform 0.2s, box-shadow 0.2s;
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
  }
  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
  }
  .form-range {
    height: 0.5rem;
  }
  .form-range::-webkit-slider-thumb {
    width: 1.5rem;
    height: 1.5rem;
    background-color: #0d6efd;
    cursor: pointer;
  }
  .form-range::-moz-range-thumb {
    width: 1.5rem;
    height: 1.5rem;
    background-color: #0d6efd;
    cursor: pointer;
  }
  #ethInput {
    font-size: 1.1rem;
    font-weight: 600;
    text-align: right;
  }
  #ethInput::-webkit-outer-spin-button,
  #ethInput::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  #ethInput[type=number] {
    -moz-appearance: textfield;
  }
  .bg-opacity-10 {
    --bs-bg-opacity: 0.1;
  }
</style>
{{ end }}
