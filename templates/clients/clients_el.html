{{ define "page" }}
  <div class="container mt-2">
    <div class="d-md-flex py-2 justify-content-md-between">
      <h1 class="h4 mb-1 mb-md-0"><i class="fas fa-server mx-2"></i>Execution clients</h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb font-size-1 mb-0" style="padding:0; background-color:transparent;">
          <li class="breadcrumb-item"><a href="/" title="Home">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">Execution clients</li>
        </ol>
      </nav>
    </div>
    <div class="card mt-2">
      <div class="accordion" id="network-accordion">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button id="peerGraphToggler" class="accordion-button btn-secondary collapsed" style="box-shadow: none;" type="button" data-bs-toggle="collapse" data-bs-target="#peerGraph" aria-expanded="true" aria-controls="peerGraph">
              <i class="fa-solid fa-circle-nodes" style="margin-right:5px"></i> Client graph
            </button>
          </h2>
          <div id="peerGraph" class="accordion-collapse collapse" data-bs-parent="#network-accordion">
            <div class="accordion-body peer-nodemap-wrapper">
              <div class="card-body px-0 peer-nodemap" id="nodemap">
                <div id="nodemap-loading" class="spinner-border" role="status">
                  <span class="sr-only">Loading...</span>
                </div>
              </div>
              <div class="card-body px-0 peer-nodemap-menu">
                <div class="btn-group btn-group-sm" role="group" aria-label="Network layouts" style="position: absolute; bottom: 5px; right: 10px;">
                  <button type="button" class="btn btn-secondary" disabled>Layouts</button>
                  <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="CoSE" class="btn btn-secondary" onclick='$_network.fitAnimated(peerGraph,$_network.layouts.fcose(peerGraphData.nodes.length))'><i class="fa-solid fa-share-alt"></i></button>
                  <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Circle" class="btn btn-secondary" onclick='$_network.fitAnimated(peerGraph,$_network.layouts.circle())'><i class="fa-solid fa-circle"></i></button>
                  <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Grid" class="btn btn-secondary" onclick='$_network.fitAnimated(peerGraph,$_network.layouts.grid())'><i class="fa-solid fa-th"></i></button>
                  <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Concentric" class="btn btn-secondary" onclick='$_network.fitAnimated(peerGraph,$_network.layouts.concentric(peerGraphData.nodes.length))'><i class="fa-solid fa-sun"></i></button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card mt-2">
      <div class="card-body px-0 py-3">
        <div class="table-responsive table-sorting px-0 py-1">
          <div style="text-align: right; margin-right: 15px;">
            Peer infos:
            <i class="fa fa-refresh text-muted p-1 mx-1" role="button" data-bs-toggle="tooltip" data-bs-placement="top" title="Refresh peer information" onclick="refreshPeerInfos()" style="cursor: pointer;"></i>
            <div class="btn-group btn-group-sm" role="group" aria-label="Peer info controls">
              <button type="button" id="toggleAllPeers" class="btn btn-outline-secondary" onclick='toggleAllPeers();'>Show all</button>
              <button type="button" id="toggleNodeIds" class="btn btn-outline-secondary" onclick='toggleNodeIds();'>Expand node IDs</button>
            </div>
          </div>
          <table class="table" id="clients">
            <thead>
              <tr>
                <th>
                  #
                  <div class="col-sorting">
                    <a href="/clients/execution?o=index" class="sort-link {{ if eq .Sorting "index" }}active{{ end }}"><i class="fas fa-arrow-up"></i></a>
                    <a href="/clients/execution?o=index-d" class="sort-link {{ if eq .Sorting "index-d" }}active{{ end }}"><i class="fas fa-arrow-down"></i></a>
                  </div>
                </th>
                <th>
                  Name
                  <div class="col-sorting">
                    <a href="/clients/execution?o=name" class="sort-link {{ if eq .Sorting "name" }}active{{ end }}"><i class="fas fa-arrow-up"></i></a>
                    <a href="/clients/execution?o=name-d" class="sort-link {{ if eq .Sorting "name-d" }}active{{ end }}"><i class="fas fa-arrow-down"></i></a>
                  </div>
                </th>
                <th>
                  Peers
                  <div class="col-sorting">
                    <a href="/clients/execution?o=peers" class="sort-link {{ if eq .Sorting "peers" }}active{{ end }}"><i class="fas fa-arrow-up"></i></a>
                    <a href="/clients/execution?o=peers-d" class="sort-link {{ if eq .Sorting "peers-d" }}active{{ end }}"><i class="fas fa-arrow-down"></i></a>
                  </div>
                </th>
                <th>
                  Block
                  <div class="col-sorting">
                    <a href="/clients/execution?o=block" class="sort-link {{ if eq .Sorting "block" }}active{{ end }}"><i class="fas fa-arrow-up"></i></a>
                    <a href="/clients/execution?o=block-d" class="sort-link {{ if eq .Sorting "block-d" }}active{{ end }}"><i class="fas fa-arrow-down"></i></a>
                  </div>
                </th>
                <th>
                  Block hash
                  <div class="col-sorting">
                    <a href="/clients/execution?o=blockhash" class="sort-link {{ if eq .Sorting "blockhash" }}active{{ end }}"><i class="fas fa-arrow-up"></i></a>
                    <a href="/clients/execution?o=blockhash-d" class="sort-link {{ if eq .Sorting "blockhash-d" }}active{{ end }}"><i class="fas fa-arrow-down"></i></a>
                  </div>
                </th>
                <th>
                  Status
                  <div class="col-sorting">
                    <a href="/clients/execution?o=status" class="sort-link {{ if eq .Sorting "status" }}active{{ end }}"><i class="fas fa-arrow-up"></i></a>
                    <a href="/clients/execution?o=status-d" class="sort-link {{ if eq .Sorting "status-d" }}active{{ end }}"><i class="fas fa-arrow-down"></i></a>
                  </div>
                </th>
                <th>
                  Version
                  <div class="col-sorting">
                    <a href="/clients/execution?o=version" class="sort-link {{ if eq .Sorting "version" }}active{{ end }}"><i class="fas fa-arrow-up"></i></a>
                    <a href="/clients/execution?o=version-d" class="sort-link {{ if eq .Sorting "version-d" }}active{{ end }}"><i class="fas fa-arrow-down"></i></a>
                  </div>
                </th>
                <th>Actions</th>
              </tr>
            </thead>
              <tbody>
                {{ $root := . }}
                {{ range $i, $client := .Clients }}
                  <tr>
                    <td>{{ $client.Index }}</td>
                    <td>
                      <svg class="client-node-icon" data-jdenticon-value="{{ $client.PeerID }}"></svg>
                      <span id="clientRow-{{ $client.Name }}" style="cursor:pointer;" class="client-row" data-peerid="{{ $client.PeerID}}">
                        <a href="#name={{ $client.Name }}">{{ $client.Name }}</a>
                      </span>
                    </td>
                    <td style="font-size: 0.8rem; vertical-align: middle;">
                      <span class="client-node-peer-count text-success" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Inbound Peers">
                        {{ $client.PeersInboundCounter }}
                        <i class="fa-solid fa-arrow-down"></i>
                      </span>
                      <span class="client-node-peer-count text-danger" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Outbound Peers">
                        {{ $client.PeersOutboundCounter }}
                        <i class="fa-solid fa-arrow-up"></i>
                      </span>
                      <span class="client-node-peer-count" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Total Peers">
                        {{ if $client.DidFetchPeers }}
                          ({{ $client.PeerCount }})
                        {{ else }}
                          (?)
                        {{ end }}
                      </span>
                    </td>
                    <td>{{ formatAddCommas $client.HeadSlot }}</td>
                    <td class="text-monospace">
                      <span class="text-truncate d-inline-block" style="max-width: 200px">0x{{ printf "%x" $client.HeadRoot }}</span>
                      <i class="fa fa-copy text-muted p-1" role="button" data-bs-toggle="tooltip" title="Copy to clipboard" data-clipboard-text="0x{{ printf "%x" $client.HeadRoot }}"></i>
                    </td>
                    <td>
                      {{ if eq $client.Status "online" }}
                        <span class="badge rounded-pill text-bg-success">Ready</span>
                      {{ else if eq $client.Status "synchronizing" }}
                        <span class="badge rounded-pill text-bg-warning" data-bs-toggle="tooltip" data-bs-placement="top" title="Updated: {{ formatRecentTimeShort $client.LastRefresh }}">Synchronizing</span>
                      {{ else if eq $client.Status "offline" }}
                        <span class="badge rounded-pill text-bg-secondary" data-bs-toggle="tooltip" data-bs-placement="top" title="Updated: {{ formatRecentTimeShort $client.LastRefresh }}, Error: {{ $client.LastError }}">Disconnected</span>
                      {{ else }}
                        <span class="badge rounded-pill text-bg-dark">{{ $client.Status }}</span>
                      {{ end }}
                      <span class="text-warning config-mismatch-icon" role="button" data-client-name="{{ $client.Name }}"
                        data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true"
                        title="" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                      </span>
                    </td>
                    <td>
                      <span class="text-truncate d-inline-block" style="max-width: 300px">{{ $client.Version }}</span>
                      <i class="fa fa-copy text-muted p-1" role="button" data-bs-toggle="tooltip" title="Copy to clipboard" data-clipboard-text="{{ $client.Version }}"></i>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-outline-secondary show-config-btn" 
                              data-client-name="{{ $client.Name }}"
                              data-bs-toggle="tooltip" data-bs-html="true"
                              title="">
                        <i class="fa-solid fa-book"></i>
                      </button>
                    </td>
                  </tr>
                  <tr class="collapse peerInfo" style="transition:0s" id="peerInfo-{{ $client.PeerID }}">
                    <td colspan="8" style="padding: 10px 0;" class="peer-details-container" data-peerid="{{ $client.PeerID }}">

                    </td>
                  </tr>
                {{ end }}
              </tbody>
          </table>
        </div>

        <!-- Peer details template -->
        <div class="peer-details-content d-none">
          <div class="client-row-divider">Node identity</div>
          <div class="client-node-peerinfo">
            <table class="table table-borderless table-sm client-table-info ">
              <tbody>
                <tr>
                  <td style="white-space: nowrap;">Name</td>
                  <td>
                    <code data-bind="text: name"></code>
                    <i class="fa fa-copy text-muted p-1" role="button" data-bs-placement="right" data-bs-toggle="tooltip" title="Copy to clipboard" data-bind="attr: {'data-clipboard-text': name}"></i>
                  </td>
                </tr>
                <tr>
                  <td style="white-space: nowrap;">Peer ID</td>
                  <td>
                    <code data-bind="text: peer_id"></code>
                    <i class="fa fa-copy text-muted p-1" role="button" data-bs-placement="right" data-bs-toggle="tooltip" title="Copy to clipboard" data-bind="attr: {'data-clipboard-text': peer_id}"></i>
                  </td>
                </tr>
                {{ html "<!-- ko if: showSensitivePeerInfos -->" }}
                <tr style="vertical-align: top;">
                  <td style="white-space: nowrap;">Enode</td>
                  <td>
                    <div style="word-break: break-all; text-wrap: pretty;">
                      <code data-bind="text: enode"></code>
                      <i class="fa fa-copy text-muted p-1" role="button" data-bs-placement="right" data-bs-toggle="tooltip" title="Copy to clipboard" data-bind="attr: {'data-clipboard-text': enode}"></i>
                    </div>
                  </td>
                </tr>
                <tr style="vertical-align: top;">
                  <td style="white-space: nowrap;">IP Address</td>
                  <td>
                    <div style="word-break: break-all; text-wrap: pretty;">
                      <code data-bind="text: ip_addr"></code>
                      <i class="fa fa-copy text-muted p-1" role="button" data-bs-placement="right" data-bs-toggle="tooltip" title="Copy to clipboard" data-bind="attr: {'data-clipboard-text': ip_addr}"></i>
                    </div>
                  </td>
                </tr>
                <tr style="vertical-align: top;">
                  <td style="white-space: nowrap;">Listen Address</td>
                  <td>
                    <div style="word-break: break-all; text-wrap: pretty;">
                      <code data-bind="text: listen_addr"></code>
                      <i class="fa fa-copy text-muted p-1" role="button" data-bs-placement="right" data-bs-toggle="tooltip" title="Copy to clipboard" data-bind="attr: {'data-clipboard-text': listen_addr}"></i>
                    </div>
                  </td>
                </tr>
                {{ html "<!-- /ko -->" }}
              </tbody>
            </table>
          </div>
          
          <div class="client-row-divider">
            Fork Configuration
            <span class="text-muted" style="float: right; font-size: 0.9em;">
              {{ html "<!-- ko if: fork_config() -->" }}
              Chain ID: <code data-bind="text: (fork_config().current && fork_config().current.chainId) || ''"></code>
              <i class="fa fa-copy text-muted p-1" role="button" data-bs-toggle="tooltip" title="Copy Chain ID" data-bind="click: function() { var chainId = (fork_config().current && fork_config().current.chainId) || ''; navigator.clipboard.writeText(chainId); }"></i>
              {{ html "<!-- /ko -->" }}
            </span>
          </div>
          {{ html "<!-- ko if: fork_config() -->" }}
          <div class="client-node-peerinfo">
            <table class="table table-borderless table-sm client-table-info">
              <thead>
                <tr>
                  <th style="width:15%">Fork</th>
                  <th style="width:35%">Activation Time (UTC)</th>
                  <th style="width:50%">Fork ID</th>
                </tr>
              </thead>
              <tbody>
                {{ html "<!-- ko if: fork_config().current -->" }}
                <tr>
                  <td><strong>Current</strong></td>
                  <td>
                    <code data-bind="text: new Date(fork_config().current.activationTime * 1000).toISOString().slice(0, 19).replace('T', ' ')"></code>
                    <i class="fa fa-copy text-muted" role="button" data-bs-toggle="tooltip" title="Copy" data-bind="click: function() { navigator.clipboard.writeText(fork_config().current.activationTime); }"></i>
                  </td>
                  <td>
                    <code data-bind="text: fork_config().current.forkId"></code>
                    <i class="fa fa-copy text-muted" role="button" data-bs-toggle="tooltip" title="Copy" data-bind="click: function() { navigator.clipboard.writeText(fork_config().current.forkId); }"></i>
                  </td>
                </tr>
                {{ html "<!-- /ko -->" }}
                {{ html "<!-- ko if: fork_config().next -->" }}
                <tr>
                  <td><strong>Next</strong></td>
                  <td>
                    <code data-bind="text: new Date(fork_config().next.activationTime * 1000).toISOString().slice(0, 19).replace('T', ' ')"></code>
                    <i class="fa fa-copy text-muted" role="button" data-bs-toggle="tooltip" title="Copy" data-bind="click: function() { navigator.clipboard.writeText(fork_config().next.activationTime); }"></i>
                  </td>
                  <td>
                    <code data-bind="text: fork_config().next.forkId"></code>
                    <i class="fa fa-copy text-muted" role="button" data-bs-toggle="tooltip" title="Copy" data-bind="click: function() { navigator.clipboard.writeText(fork_config().next.forkId); }"></i>
                  </td>
                </tr>
                {{ html "<!-- /ko -->" }}
                {{ html "<!-- ko if: fork_config().last -->" }}
                <tr>
                  <td><strong>Last</strong></td>
                  <td>
                    <code data-bind="text: new Date(fork_config().last.activationTime * 1000).toISOString().slice(0, 19).replace('T', ' ')"></code>
                    <i class="fa fa-copy text-muted" role="button" data-bs-toggle="tooltip" title="Copy" data-bind="click: function() { navigator.clipboard.writeText(fork_config().last.activationTime); }"></i>
                  </td>
                  <td>
                    <code data-bind="text: fork_config().last.forkId"></code>
                    <i class="fa fa-copy text-muted" role="button" data-bs-toggle="tooltip" title="Copy" data-bind="click: function() { navigator.clipboard.writeText(fork_config().last.forkId); }"></i>
                  </td>
                </tr>
                {{ html "<!-- /ko -->" }}
              </tbody>
            </table>
          </div>
          {{ html "<!-- /ko -->" }}
          {{ html "<!-- ko ifnot: fork_config() -->" }}
          <div class="client-node-peerinfo">
            <p style="color: #888; font-style: italic;">Fork configuration data not available for this client.</p>
          </div>
          {{ html "<!-- /ko -->" }}
          
          <div class="client-row-divider" style="position: relative;">
            Peers
            <button type="button" class="btn btn-outline-secondary btn-sm peer-collapse-btn" data-bs-toggle="collapse" data-bind="attr: {'data-bs-target': '#peer-details-list-' + peer_id(), 'aria-controls': 'peer-details-list-' + peer_id()}" aria-expanded="false" style="position: absolute; right: 0; top: 0;">
              <i class="fa fa-chevron-down"></i> Show Connected Peers
            </button>
          </div>
          <div class="collapse peer-details-collapse" data-bind="attr: {id: 'peer-details-list-' + peer_id()}">
            <div class="peer-table-column">
              {{ html "<!-- ko foreach: peers -->" }}
                <div style="padding-left: 20px; padding-top:3px">
                  {{ html "<!-- ko if: direction == 'inbound' -->" }}
                    <i class="fa-solid fa-down-long text-success" data-bs-toggle="tooltip" data-bs-placement="left" data-bs-title="Inbound"></i>
                  {{ html "<!-- /ko -->" }}
                  {{ html "<!-- ko if: direction == 'outbound' -->" }}
                    <i class="fa-solid fa-up-long text-danger" data-bs-toggle="tooltip" data-bs-placement="left" data-bs-title="Outbound"></i>
                  {{ html "<!-- /ko -->" }}
                  <svg data-bind="attr: {'data-jdenticon-value': id}, class: 'peer-table-icon '+status"></svg>
                  <code data-bind="text: id"></code>
                  <i class="fa fa-copy text-muted p-1" role="button" data-bs-toggle="tooltip" title="Copy to clipboard" data-bind="attr: {'data-clipboard-text': id}"></i>
                  {{ html "<!-- ko if: type == 'internal' -->" }}
                    <span class="badge text-bg-secondary" data-bind="text: alias"></span>
                  {{ html "<!-- /ko -->" }}
                </div>
                {{ html "<!-- ko if: $root.showSensitivePeerInfos -->" }}
                  <div class="client-node-peer-details">
                    <table class="table table-borderless table-sm client-table-info" style="padding-left:0; margin-top:10px;margin-bottom: 10px; margin-left: 10px;">
                      <tbody>
                        <tr>
                          <td>Enode</td>
                          <td>
                            <div style="word-break: break-all; text-wrap: pretty;">
                              <code data-bind="text: enode"></code>
                              <i class="fa fa-copy text-muted p-1" role="button" data-bs-placement="right" data-bs-toggle="tooltip" title="Copy to clipboard" data-bind="attr: {'data-clipboard-text': enode}"></i>
                            </div>
                          </td>
                        </tr>
                        <tr>
                          <td>Name</td>
                          <td>
                            <div style="word-break: break-all; text-wrap: pretty;">
                              <code data-bind="text: name"></code>
                              <i class="fa fa-copy text-muted p-1" role="button" data-bs-placement="right" data-bs-toggle="tooltip" title="Copy to clipboard" data-bind="attr: {'data-clipboard-text': name}"></i>
                            </div>
                          </td>
                        </tr>
                        <tr>
                          <td>Capabilities</td>
                          <td>
                            <div style="word-break: break-all; text-wrap: pretty;">
                              <code data-bind="text: JSON.stringify(caps)"></code>
                              <i class="fa fa-copy text-muted p-1" role="button" data-bs-placement="right" data-bs-toggle="tooltip" title="Copy to clipboard" data-bind="attr: {'data-clipboard-text': JSON.stringify(caps)}"></i>
                            </div>
                          </td>
                        </tr>
                        <tr>
                          <td>Protocols</td>
                          <td>
                            <div style="word-break: break-all; text-wrap: pretty;">
                              <code style="white-space: pre-wrap;" data-bind="text: JSON.stringify(protocols, null, 2)"></code>
                              <i class="fa fa-copy text-muted p-1" role="button" data-bs-placement="right" data-bs-toggle="tooltip" title="Copy to clipboard" data-bind="attr: {'data-clipboard-text': JSON.stringify(protocols, null, 2)}"></i>
                            </div>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                {{ html "<!-- /ko -->" }}
              {{ html "<!-- /ko -->" }}
            </div>
          </div>
        </div>

      </div>
      <div id="footer-placeholder" style="height:30px;"></div>
    </div>
  </div>

  <script type="text/javascript">
    $(document).ready(function() {
      hashParams = new URLSearchParams(window.location.hash.substring(1))
      if (hashParams.has("name")) {
        name = hashParams.get("name")
        clientRow = $("#clientRow-" + name)
        if (clientRow) {
          clientRow.click()
        }
      }
      
      // Check refresh cooldown status on page load
      if (typeof window.explorer !== 'undefined' && window.explorer.checkRefreshCooldown) {
        window.explorer.checkRefreshCooldown();
      }
    });
  </script>

  <!-- Config Mismatch Modal -->
  <div class="modal fade" id="configMismatchModal" tabindex="-1" role="dialog" aria-labelledby="configMismatchModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 1420px; width: 1420px;" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="configMismatchModalTitle">
            <i class="fas fa-code-compare text-warning me-2"></i>Configuration Comparison: <span id="configMismatchModalClientName"></span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="configMismatchModalBody" style="max-height: 80vh; overflow-x: auto; overflow-y: auto;">
          <!-- Content will be populated dynamically -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

{{ end }}

{{ define "js" }}
<script src="/js/vendor/jdenticon-3.3.0.min.js"></script>
<script src="/js/knockout.min.js"></script>
<script src="/js/vendor/cytoscape.min.js"></script>
<script src="/js/vendor/cytoscape-layout-base.js"></script>
<script src="/js/vendor/cytoscape-cose-base.js"></script>
<script src="/js/vendor/cytoscape-fcose.js"></script>
<script src="/js/cytoscape-network-aux.js"></script>
<script type="text/javascript">
  var peerGraphData = {{ .PeerMap }};
  var peerGraph, peerGraphRendered = false;

  var nodes = {{ .Nodes }};

  function renderPeerGraph() {
    var container = document.getElementById("nodemap");
    peerGraph = $_network.create(container, peerGraphData);
  }

  $('#peerGraph').on('shown.bs.collapse', function () {
    if(peerGraphRendered) return;
    renderPeerGraph();
    peerGraphRendered = true;
  });

  $('.client-row').on('click', function() {
    var peerId = $(this).data('peerid');
    if(peerGraph) {
      $_network.isolateNode(peerGraph, peerId);
    }
    $('.collapse.peerInfo').collapse('hide');
    $('#peerInfo-' + peerId).collapse('show');
  });

  (function() {
    // shared base model for knockout bindings
    var baseModel = {
      showSensitivePeerInfos: {{ .ShowSensitivePeerInfos }},
      getNode: function(peerId) { return nodes[peerId] },
      getNodeName: function(peerId) { return nodes[peerId] ? nodes[peerId].alias : "" },
      getEnrValue: function(enr_kv, key) {
        for(var i = 0; i < enr_kv.length; i++) {
          if(enr_kv[i].key == key)
            return enr_kv[i].value;
        }
        return "";
      },
    };

    // Peer details view model
    (function() {
      function createModel(data) {
        var viewModel = Object.create(baseModel);
        var val;
        for(var prop in data) {
          val = data[prop];
          if(Array.isArray(val))
            viewModel[prop] = ko.observableArray(val);
          else
            viewModel[prop] = ko.observable(val);
        }
        return viewModel;
      }

      $('.peerInfo').on('shown.bs.collapse', function () {
        var detailsContainer = $(this).find('.peer-details-container');
        if(detailsContainer.data('loaded')) return;

        var peerId = detailsContainer.data('peerid');
        detailsContainer.data('loaded', true);
        var template = $(".peer-details-content").html();
        detailsContainer.html(template);

        var viewModel = createModel(nodes[peerId]);
        ko.applyBindings(viewModel, detailsContainer.get(0));
        window.explorer.initControls();
        jdenticon.update(".peer-table-icon",null);
        
        // Initialize peer collapse handlers for this instance
        initPeerCollapseHandlers(detailsContainer);
      });

    })();
  })();

  // Config mismatch modal
  (function() {
    // Store expected config data only
    window.expectedConfig = JSON.parse({{ includeJSON .ExpectedEthConfig false }});

    // Initialize tooltips for config mismatch icons and show config buttons
    $(document).ready(function() {
      $('.config-mismatch-icon, .show-config-btn').each(function() {
        var clientName = $(this).data('client-name');
        var client = null;
        
        // Find the client
        for (var nodeId in nodes) {
          if (nodes[nodeId].name === clientName) {
            client = nodes[nodeId];
            break;
          }
        }
        
        if (client && client.fork_config) {
          var summary = calculateConfigSummary(window.expectedConfig, client.fork_config);
          var tooltipContent = '';
          
          if ($(this).hasClass('config-mismatch-icon')) {
            // Only show warning icon if there are missing or mismatched values
            if (summary.missingCount > 0 || summary.mismatchCount > 0) {
              $(this).show();
              
              tooltipContent = '<strong>Config Mismatch Detected</strong><br/>';
              tooltipContent += summary.missingCount + ' missing, ';
              tooltipContent += summary.mismatchCount + ' mismatched, ';
              tooltipContent += summary.untrackedCount + ' additional untracked fields<br/>';
              tooltipContent += '<em>Click for details.</em>';
              
              $(this).attr('title', tooltipContent);
            }
          } else {
            tooltipContent = '<strong>Show config values</strong><br/>';
            tooltipContent += summary.missingCount + ' missing, ';
            tooltipContent += summary.mismatchCount + ' mismatched, ';
            tooltipContent += summary.untrackedCount + ' additional untracked fields<br/>';
            tooltipContent += '<em>Click for details.</em>';
            
            $(this).attr('title', tooltipContent);
          }
        }
      });
      
      // Initialize Bootstrap tooltips
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('.config-mismatch-icon[data-bs-toggle="tooltip"], .show-config-btn[data-bs-toggle="tooltip"]'));
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
    });

    // Click handler for config mismatch icons
    $(document).on('click', '.config-mismatch-icon', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      var clientName = $(this).data('client-name');
      var client = null;
      
      // First try to find by PeerID if it exists
      for (var nodeId in nodes) {
        if (nodes[nodeId].name === clientName) {
          client = nodes[nodeId];
          break;
        }
      }
      
      if (client && client.fork_config) {
        showConfigMismatchModal(client);
      }
    });

    // Click handler for show config buttons
    $(document).on('click', '.show-config-btn', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      var clientName = $(this).data('client-name');
      var client = null;
      
      // First try to find by PeerID if it exists
      for (var nodeId in nodes) {
        if (nodes[nodeId].name === clientName) {
          client = nodes[nodeId];
          break;
        }
      }
      
      if (client && client.fork_config) {
        showConfigMismatchModal(client);
      }
    });

    // Calculate summary statistics for config comparison
    function calculateConfigSummary(expectedConfig, clientConfig) {
      var missingCount = 0;
      var mismatchCount = 0;
      var untrackedCount = 0;
      
      var sections = ['current', 'next', 'last'];
      
      sections.forEach(function(section) {
        var expectedSection = expectedConfig ? expectedConfig[section] : undefined;
        var clientSection = clientConfig ? clientConfig[section] : undefined;
        
        if (expectedSection) {
          Object.keys(expectedSection).forEach(function(field) {
            var expectedValue = expectedSection[field];
            var clientValue = clientSection ? clientSection[field] : undefined;
            
            if (field === 'blobSchedule') {
              // Special handling for blob schedule
              if (!clientValue && expectedValue) {
                missingCount++;
              } else if (clientValue && expectedValue && JSON.stringify(clientValue) !== JSON.stringify(expectedValue)) {
                mismatchCount++;
              }
            } else if (field === 'precompiles' || field === 'systemContracts') {
              // Special handling for object fields
              if (!clientValue && expectedValue) {
                missingCount++;
              } else if (clientValue && expectedValue && JSON.stringify(clientValue) !== JSON.stringify(expectedValue)) {
                mismatchCount++;
              }
            } else {
              // Simple field comparison
              if (expectedValue !== undefined && (clientValue === undefined || clientValue === null)) {
                missingCount++;
              } else if (expectedValue !== undefined && clientValue !== undefined && expectedValue !== clientValue) {
                mismatchCount++;
              }
            }
          });
        }
        
        // Count untracked fields
        if (clientSection) {
          Object.keys(clientSection).forEach(function(field) {
            var isInExpected = expectedSection && expectedSection.hasOwnProperty(field);
            if (!isInExpected) {
              untrackedCount++;
            }
          });
        }
      });
      
      return {
        missingCount: missingCount,
        mismatchCount: mismatchCount,
        untrackedCount: untrackedCount
      };
    }

    function showConfigMismatchModal(client) {
      $('#configMismatchModalClientName').text(client.name);
      var modalBody = $('#configMismatchModalBody');
      
      // Calculate summary statistics
      var summary = calculateConfigSummary(window.expectedConfig, client.fork_config);
      
      var html = '<h6>Configuration comparison between client and expected network settings:</h6>';
      
      // Add summary section
      html += '<div class="alert alert-info" role="alert">';
      html += '<i class="fas fa-info-circle me-2"></i>';
      html += '<strong>Summary:</strong> ';
      html += summary.missingCount + ' missing, ';
      html += summary.mismatchCount + ' mismatched, ';
      html += summary.untrackedCount + ' additional untracked fields';
      html += '</div>';
      
      // Helper function to create comparison table for a fork section
      function createComparisonTable(sectionName, expectedFork, clientFork) {
        var sectionHtml = '<div class="mb-4">';
        sectionHtml += '<h6 class="text-primary">' + sectionName + ' Fork Configuration</h6>';
        sectionHtml += '<div class="table-responsive" style="min-width: 1350px;">';
        sectionHtml += '<table class="table table-striped table-hover table-sm" style="table-layout: fixed; width: 1350px;">';
        sectionHtml += '<thead class="table-dark"><tr><th style="width: 450px; min-width: 450px;">Field</th><th style="width: 450px; min-width: 450px;">Client</th><th style="width: 450px; min-width: 450px;">Expected</th></tr></thead>';
        sectionHtml += '<tbody>';
        
        // Compare all fields in the fork config
        var allFields = new Set();
        
        // Collect all fields from both expected and client configs
        if (expectedFork) {
          Object.keys(expectedFork).forEach(function(field) {
            allFields.add(field);
          });
        }
        if (clientFork) {
          Object.keys(clientFork).forEach(function(field) {
            allFields.add(field);
          });
        }
        
        // Define field order for better organization
        var fieldOrder = ['activationTime', 'chainId', 'forkId', 'blobSchedule', 'precompiles', 'systemContracts'];
        var orderedFields = [];
        
        // Add fields in preferred order
        fieldOrder.forEach(function(field) {
          if (allFields.has(field)) {
            orderedFields.push(field);
            allFields.delete(field);
          }
        });
        
        // Add remaining fields
        allFields.forEach(function(field) {
          orderedFields.push(field);
        });
        
        // Compare each field
        orderedFields.forEach(function(field) {
          var expectedValue = expectedFork ? expectedFork[field] : undefined;
          var clientValue = clientFork ? clientFork[field] : undefined;
          
          /* // Always show key fields, skip others only if they match exactly
          var isKeyField = ['activationTime', 'chainId', 'forkId'].includes(field);
          if (!isKeyField && JSON.stringify(expectedValue) === JSON.stringify(clientValue)) {
            return;
          }
          */
          
          // Handle complex objects with sub-rows
          if (field === 'blobSchedule') {
            sectionHtml += createBlobScheduleRows(expectedValue, clientValue);
          } else if (field === 'precompiles') {
            sectionHtml += createPrecompilesRows(expectedValue, clientValue);
          } else if (field === 'systemContracts') {
            sectionHtml += createSystemContractsRows(expectedValue, clientValue);
          } else {
            // Handle simple fields
            sectionHtml += '<tr>';
            var readableFieldName = field.replace(/([A-Z])/g, ' $1').replace(/^./, function(str){ return str.toUpperCase(); });
            sectionHtml += '<td>';
            sectionHtml += '<strong>' + escapeHtml(readableFieldName) + '</strong>';
            sectionHtml += '</td>';
            sectionHtml += '<td>' + formatSimpleValue(clientValue, expectedValue) + '</td>';
            sectionHtml += '<td>' + formatSimpleValue(expectedValue, true) + '</td>';
            sectionHtml += '</tr>';
          }
        });
        
        sectionHtml += '</tbody></table></div></div>';
        return sectionHtml;
      }
      
      // Create sub-rows for blob schedule
      function createBlobScheduleRows(expectedBlob, clientBlob) {
        var html = '';
        var blobFields = ['max', 'target', 'baseFeeUpdateFraction'];
        
        // Header row for blob schedule
        html += '<tr style="background-color: var(--bs-secondary-bg); border-top: 2px solid var(--bs-border-color);">';
        html += '<td><strong>ðŸ”¹ Blob Schedule</strong></td>';
        html += '<td colspan="2"></td>';
        html += '</tr>';
        
        blobFields.forEach(function(field) {
          var expectedValue = expectedBlob ? expectedBlob[field] : undefined;
          var clientValue = clientBlob ? clientBlob[field] : undefined;
          
          html += '<tr>';
          html += '<td style="padding-left: 2rem;">';
          html += '<span class="text-muted">â”œâ”€</span> ' + escapeHtml(field);
          html += '</td>';
          html += '<td>' + formatSimpleValue(clientValue, expectedValue) + '</td>';
          html += '<td>' + formatSimpleValue(expectedValue, true) + '</td>';
          html += '</tr>';
        });
        
        return html;
      }
      
      // Create sub-rows for precompiles
      function createPrecompilesRows(expectedPrecompiles, clientPrecompiles) {
        var html = '';
        var allPrecompiles = new Set();
        
        if (expectedPrecompiles) Object.keys(expectedPrecompiles).forEach(function(key) { allPrecompiles.add(key); });
        if (clientPrecompiles) Object.keys(clientPrecompiles).forEach(function(key) { allPrecompiles.add(key); });
        
        if (allPrecompiles.size === 0) return '';
        
        // Header row for precompiles
        html += '<tr style="background-color: var(--bs-secondary-bg); border-top: 2px solid var(--bs-border-color);">';
        html += '<td><strong>ðŸ”¹ Precompiles</strong></td>';
        html += '<td colspan="2"><em>' + allPrecompiles.size + ' precompiles</em></td>';
        html += '</tr>';
        
        // Sort precompiles for consistent display
        var sortedPrecompiles = Array.from(allPrecompiles).sort();
        
        sortedPrecompiles.forEach(function(precompile) {
          var expectedValue = expectedPrecompiles ? expectedPrecompiles[precompile] : undefined;
          var clientValue = clientPrecompiles ? clientPrecompiles[precompile] : undefined;
          
          html += '<tr>';
          html += '<td style="padding-left: 2rem;">';
          html += '<span class="text-muted">â”œâ”€</span> ' + escapeHtml(precompile);
          html += '</td>';
          html += '<td>' + formatSimpleValue(clientValue, expectedValue) + '</td>';
          html += '<td>' + formatSimpleValue(expectedValue, true) + '</td>';
          html += '</tr>';
        });
        
        return html;
      }
      
      // Create sub-rows for system contracts
      function createSystemContractsRows(expectedContracts, clientContracts) {
        var html = '';
        var allContracts = new Set();
        
        if (expectedContracts) Object.keys(expectedContracts).forEach(function(key) { allContracts.add(key); });
        if (clientContracts) Object.keys(clientContracts).forEach(function(key) { allContracts.add(key); });
        
        if (allContracts.size === 0) return '';
        
        // Header row for system contracts
        html += '<tr style="background-color: var(--bs-secondary-bg); border-top: 2px solid var(--bs-border-color);">';
        html += '<td><strong>ðŸ”¹ System Contracts</strong></td>';
        html += '<td colspan="2"><em>' + allContracts.size + ' contracts</em></td>';
        html += '</tr>';
        
        // Sort contracts for consistent display
        var sortedContracts = Array.from(allContracts).sort();
        
        sortedContracts.forEach(function(contract) {
          var expectedValue = expectedContracts ? expectedContracts[contract] : undefined;
          var clientValue = clientContracts ? clientContracts[contract] : undefined;
          
          html += '<tr>';
          html += '<td style="padding-left: 2rem;">';
          html += '<span class="text-muted">â”œâ”€</span> ' + escapeHtml(contract);
          html += '</td>';
          html += '<td>' + formatSimpleValue(clientValue, expectedValue) + '</td>';
          html += '<td>' + formatSimpleValue(expectedValue, true) + '</td>';
          html += '</tr>';
        });
        
        return html;
      }
      
      // Format simple values (non-objects)
      function formatSimpleValue(value, expectedValue) {
        if (value === undefined || value === null) {
          return '<span class="text-muted">N/A</span>';
        }
        
        // If expectedValue is boolean true, it means this is the expected column
        if (expectedValue === true) {
          return '<code class="text-success">' + escapeHtml(String(value)) + '</code>';
        }
        
        // For client values, only show red if they don't match expected
        var cssClass = 'text-success';
        if (expectedValue !== undefined && JSON.stringify(value) !== JSON.stringify(expectedValue)) {
          cssClass = 'text-danger';
        }
        
        return '<code class="' + cssClass + '">' + escapeHtml(String(value)) + '</code>';
      }
      
      // Compare current, next, and last configurations
      if (window.expectedConfig && client.fork_config) {
        // Current configuration
        if (window.expectedConfig.current || client.fork_config.current) {
          html += createComparisonTable('Current', window.expectedConfig.current, client.fork_config.current);
        }
        
        // Next configuration
        if (window.expectedConfig.next || client.fork_config.next) {
          html += createComparisonTable('Next', window.expectedConfig.next, client.fork_config.next);
        }
        
        // Last configuration
        if (window.expectedConfig.last || client.fork_config.last) {
          html += createComparisonTable('Last', window.expectedConfig.last, client.fork_config.last);
        }
      }
      
      modalBody.html(html);
      var modalElement = document.getElementById('configMismatchModal');
      var modal = new bootstrap.Modal(modalElement);
      modal.show();
    }

    function getConfigValue(config, path) {
      if (!config) return undefined;
      
      // Handle paths like "current.activationTime"
      var parts = path.split('.');
      var value = config;
      
      for (var i = 0; i < parts.length; i++) {
        if (value && typeof value === 'object') {
          value = value[parts[i]];
        } else {
          return undefined;
        }
      }
      
      return value;
    }

    function formatConfigValue(value, isExpected) {
      if (value === undefined || value === null) {
        return '<span class="text-muted">N/A</span>';
      }
      
      if (typeof value === 'object') {
        // Format objects and arrays
        return formatComplexValue(value, isExpected);
      }
      
      // Format primitive values
      var cssClass = isExpected ? 'text-success' : 'text-danger';
      return '<code class="' + cssClass + '">' + escapeHtml(String(value)) + '</code>';
    }
    
    function formatComplexValue(value, isExpected) {
      var cssClass = isExpected ? 'text-success' : 'text-danger';
      var formatted = '<div class="' + cssClass + '" style="font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto;">';
      formatted += escapeHtml(JSON.stringify(value, null, 2));
      formatted += '</div>';
      return formatted;
    }

    function escapeHtml(text) {
      if (text === undefined || text === null) {
        return '';
      }
      var map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
    }
  })();

  // Function to initialize peer collapse handlers for a specific container
  function initPeerCollapseHandlers(container) {
    container.find('.peer-details-collapse').on('show.bs.collapse', function () {
      $(this).siblings('.client-row-divider').find('.peer-collapse-btn').html('<i class="fa fa-chevron-up"></i> Hide Connected Peers');
    });

    container.find('.peer-details-collapse').on('hide.bs.collapse', function () {
      $(this).siblings('.client-row-divider').find('.peer-collapse-btn').html('<i class="fa fa-chevron-down"></i> Show Connected Peers');
    });
  }

  // Function to toggle all peer info sections (right button)
  function toggleAllPeers() {
    var rightButton = $('#toggleAllPeers');
    var leftButton = $('#toggleNodeIds');
    var rightButtonText = rightButton.text();
    
    if (rightButtonText === 'Show all') {
      // Show all peer info sections
      $('.collapse.peerInfo').collapse('show');
      
      // Wait for the peer info sections to be shown, then show all connected peers
      setTimeout(function() {
        $('.peer-details-collapse').collapse('show');
      }, 500);
      
      // Right button: Show all -> Hide all
      rightButton.text('Hide all');
      // Left button: Expand node IDs -> Hide peers
      leftButton.text('Hide peers');
      leftButton.show();
    } else if (rightButtonText === 'Show peers') {
      // Show connected peers (peer info sections are already shown)
      $('.peer-details-collapse').collapse('show');
      
      // Right button: Show peers -> Hide all
      rightButton.text('Hide all');
      // Left button: Hide all node IDs -> Hide peers
      leftButton.text('Hide peers');
      leftButton.show();
    } else {
      // Hide all peer info sections
      $('.collapse.peerInfo').collapse('hide');
      
      // Right button: Hide all -> Show all
      rightButton.text('Show all');
      // Left button: Hide peers -> Expand node IDs
      leftButton.text('Expand node IDs');
      leftButton.show();
    }
  }

  // Function to toggle node IDs display (left button)
  function toggleNodeIds() {
    var leftButton = $('#toggleNodeIds');
    var rightButton = $('#toggleAllPeers');
    var leftButtonText = leftButton.text();
    
    if (leftButtonText === 'Expand node IDs') {
      // Show all peer info sections to reveal node identity details
      $('.collapse.peerInfo').collapse('show');
      
      // Wait for the peer info sections to be shown, then hide all connected peers
      setTimeout(function() {
        $('.peer-details-collapse').collapse('hide');
      }, 500);
      
      // Left button: Expand node IDs -> Hide all node IDs
      leftButton.text('Hide all node IDs');
      // Right button: Show all -> Show peers
      rightButton.text('Show peers');
    } else if (leftButtonText === 'Hide peers') {
      // Hide only the connected peers, keep node IDs visible
      $('.peer-details-collapse').collapse('hide');
      
      // Left button: Hide peers -> Hide all node IDs
      leftButton.text('Hide all node IDs');
      // Right button: Hide all -> Show peers
      rightButton.text('Show peers');
    } else {
      // Hide all peer info sections (Hide all node IDs)
      $('.collapse.peerInfo').collapse('hide');
      
      // Left button: Hide all node IDs -> Expand node IDs
      leftButton.text('Expand node IDs');
      // Right button: Show peers -> Show all
      rightButton.text('Show all');
    }
  }


</script>
{{ end }}
{{ define "css" }}
<link rel="stylesheet" href="/css/clients.css" />
<style>
#toggleAllPeers, #toggleNodeIds {
  min-width: 140px;
  width: 140px;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Config mismatch icon styling */
.config-mismatch-icon {
  cursor: pointer;
  margin-left: 5px;
}

.config-mismatch-icon:hover {
  opacity: 0.8;
}

/* Config mismatch modal table styling */
#configMismatchModal .table td {
  vertical-align: middle;
}

#configMismatchModal .table code {
  word-break: break-all;
}

#configMismatchModal pre {
  max-height: 300px;
  overflow-y: auto;
  font-size: 0.875rem;
}
</style>
{{ end }}
