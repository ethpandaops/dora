{{ define "page" }}

{{ $root := . }}
  <div class="container mt-2">
    <div class="d-md-flex py-2 justify-content-md-between">
      <h1 class="h4 mb-1 mb-md-0"><i class="fas fa-server mx-2"></i>Consensus clients</h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb font-size-1 mb-0" style="padding:0; background-color:transparent;">
          <li class="breadcrumb-item"><a href="/" title="Home">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">Consensus clients</li>
        </ol>
      </nav>
    </div>

    <div class="card mt-2">
      <div class="accordion" id="network-accordion">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button id="peerGraphToggler" class="accordion-button btn-secondary collapsed" style="box-shadow: none;" type="button" data-bs-toggle="collapse" data-bs-target="#peerGraph" aria-expanded="false" aria-controls="peerGraph">
              <i class="fa-solid fa-circle-nodes" style="margin-right:5px"></i> Client graph
            </button>
          </h2>
          <div id="peerGraph" class="accordion-collapse collapse" data-bs-parent="#network-accordion">
            <div class="accordion-body peer-nodemap-wrapper">
              <div class="card-body px-0 peer-nodemap" id="nodemap">
                <div id="nodemap-loading" class="spinner-border" role="status">
                  <span class="sr-only">Loading...</span>
                </div>
              </div>
              <div class="card-body px-0 peer-nodemap-menu">
                <div class="btn-group btn-group-sm" role="group" aria-label="Network layouts" style="position: absolute; bottom: 5px; right: 10px;">
                  <button type="button" class="btn btn-secondary" disabled>Layouts</button>
                  <button type="button" data-toggle="tooltip" data-placement="top" title="CoSE" class="btn btn-secondary" onclick='$_network.fitAnimated(peerGraph,$_network.layouts.fcose(peerGraphData.nodes.length))'><i class="fa-solid fa-share-alt"></i></button>
                  <button type="button" data-toggle="tooltip" data-placement="top" title="Circle" class="btn btn-secondary" onclick='$_network.fitAnimated(peerGraph,$_network.layouts.circle())'><i class="fa-solid fa-circle"></i></button>
                  <button type="button" data-toggle="tooltip" data-placement="top" title="Grid" class="btn btn-secondary" onclick='$_network.fitAnimated(peerGraph,$_network.layouts.grid())'><i class="fa-solid fa-th"></i></button>
                  <button type="button" data-toggle="tooltip" data-placement="top" title="Concentric" class="btn btn-secondary" onclick='$_network.fitAnimated(peerGraph,$_network.layouts.concentric(peerGraphData.nodes.length))'><i class="fa-solid fa-sun"></i></button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {{ if $root.ShowPeerDASInfos }}
    <div class="card mt-2">
      <div class="accordion" id="peerdas-columns-accordion">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button btn-secondary collapsed" style="box-shadow: none;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseColumnInfos" aria-expanded="false" aria-controls="collapseColumnInfos">
              <i class="fa-solid fa-table-columns" style="margin-right:5px"></i> PeerDAS column custody
              <span class="badge badge-pill badge-secondary">Total peers: {{ len $root.Nodes }}</span>
            </button>
          </h2>
          <div id="collapseColumnInfos" class="accordion-collapse collapse" data-bs-parent="#peerdas-columns-accordion">
            <div class="accordion-body">
              <div>
                {{ if $root.PeerDASInfos.Warnings.HasWarnings }}
                <button style="float: right" type="button" class="btn btn-warning btn-sm font-weight-bold" data-toggle="modal" data-target="#peerDasWarningsModal" onclick="$('#peerDasWarningsModal').modal('show')">
                  ‚ö†Ô∏è Show warnings
                </button>
                {{ end}}
                <p>
                  Spec configuration:
                  <code>NUMBER_OF_COLUMNS={{ $root.PeerDASInfos.NumberOfColumns}}</code>,
                  <code>DATA_COLUMN_SIDECAR_SUBNET_COUNT={{ $root.PeerDASInfos.DataColumnSidecarSubnetCount}}</code>
                  <code>CUSTODY_REQUIREMENT={{ $root.PeerDASInfos.CustodyRequirement}}</code>
                  Node count: <code>{{ len $root.Nodes }}</code>
                  <div class="form-check form-switch" style="display: inline-block">
                    <input class="form-check-input" type="checkbox" role="switch" id="showExternalPeersDAS" onChange="filterDASTablePeers();" checked>
                    <label class="form-check-label" for="showExternalPeersDAS">External peers</label>
                  </div>
                  <div class="form-check form-switch" style="display: inline-block">
                    <input class="form-check-input" type="checkbox" role="switch" id="showInternalPeersDAS" onChange="filterDASTablePeers();" checked>
                    <label class="form-check-label" for="showInternalPeersDAS">Internal peers</label>
                  </div>
                  <div class="form-check form-switch" style="display: inline-block">
                    <input class="form-check-input" type="checkbox" role="switch" id="showSupernodePeersDAS" onChange="filterDASTablePeers();" checked>
                    <label class="form-check-label" for="showSupernodePeersDAS">Supernode peers</label>
                  </div>
                  <div class="input-group" style="margin-top:10px;">
                    <input class="form-control" list="datalistOptions" id="searchDASTablePeers" placeholder="Type to search...">
                    <button class="btn btn-outline-secondary" type="button" id="clearSearchButton">Clear</button>
                  </div>
                  <datalist id="datalistOptions">
                    {{ range $k, $p := $root.Nodes }}
                      <option value="{{ $p.PeerID }}">
                      {{ if ne $p.Alias $p.PeerID }}
                      <option value="{{ $p.Alias }}">
                      {{ end }}
                    {{ end }}
                  </datalist>
                </p>
              </div>

              <!--- Peer DAS Warnings modal -->
             <div class="modal fade" id="peerDasWarningsModal" tabindex="-1" role="dialog" aria-labelledby="peerDasWarningsModal" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="peerDasWarningsModal">üëÄ PeerDAS: Some problems were detected</h5>
                    <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close" onclick="$('#peerDasWarningsModal').modal('hide')"></button>
                  </div>
                  <div class="modal-body">
                    <div>
                      {{ if $root.PeerDASInfos.Warnings.MissingSpecValues }}
                        <p><b><i class="fa-solid fa-triangle-exclamation text-warning"></i> Missing spec config:</b></p>
                        <p>Some spec configuration values are missing in the network configuration. Settings have been set to use defaults.</p>
                        <hr/>
                      {{ end }}
                      {{ if gt (len $root.PeerDASInfos.Warnings.EmptyColumns) 0 }}
                        <p><b><i class="fa-solid fa-triangle-exclamation text-warning"></i> There are {{ len $root.PeerDASInfos.Warnings.EmptyColumns }} empty columns:</b></p>
                        <p>The following columns are empty and have no peers assigned to them: <code>{{ $root.PeerDASInfos.Warnings.EmptyColumns }}</code></p>
                        <hr/>
                      {{ end }}
                      {{ if gt (len $root.PeerDASInfos.Warnings.MissingENRsPeers) 0 }}
                      <p><b><i class="fa-solid fa-triangle-exclamation text-warning"></i> Missing ENR on {{ len $root.PeerDASInfos.Warnings.MissingENRsPeers }} nodes:</b></p>
                      <p>Calculating the right columns for these peers might not be be possible due to the missing ENR.
                        The default custody requirement of <code>{{ $root.PeerDASInfos.CustodyRequirement}}</code> will be used for these nodes.
                      </p>
                      <ul>
                        {{ range $i, $p := $root.PeerDASInfos.Warnings.MissingENRsPeers }}
                          <li>
                            <code class="peerdetails-modal-peer" onclick="showPeerDetailsModal('{{ $p }}')">{{ $p }}</code>
                          </li>
                        {{ end }}
                      </ul>
                      <hr/>
                      {{ end }}
                      {{ if gt (len $root.PeerDASInfos.Warnings.MissingCGCFromENRPeers) 0 }}
                      <p><b><i class="fa-solid fa-triangle-exclamation text-warning"></i> Missing <code>cgc</code> field in ENR on {{ len $root.PeerDASInfos.Warnings.MissingCGCFromENRPeers}} nodes:</b></p>
                      <p>
                        Calculating the right columns for these peers might not be be possible due to the missing `cgc` field.
                        The default custody requirement of <code>{{ $root.PeerDASInfos.CustodyRequirement}}</code> will be used for these nodes.
                      </p>
                      <ul>
                        {{ range $i, $p := $root.PeerDASInfos.Warnings.MissingCGCFromENRPeers }}
                          <li>
                            <code class="peerdetails-modal-peer" onclick="showPeerDetailsModal('{{ $p }}')">{{ $p }}</code>
                            {{ $peer := index $root.Nodes $p}}
                            {{ if ne $peer.Alias $peer.PeerID }}
                            ( <code>{{ $peer.Alias }}</code> )
                            {{ end }}
                          </li>
                        {{ end }}
                      </ul>
                      <hr/>
                      {{ end }}
                     </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="$('#peerDasWarningsModal').modal('hide')">Close</button>
                  </div>
                </div>
              </div>
            </div>

            <div id="peerdas-table-container">
              <!-- PeerDAS table will be rendered here when accordion is opened -->
            </div>

            <!-- Hidden template for PeerDAS table -->
            <div id="peerdas-table-template" style="display: none;">
              {{ range $i := until $root.PeerDASInfos.TotalRows }}
              <div class="table-responsive">
                <table class="bg-dark text-white-50" style="margin: 0 auto; text-align: center; border: 1px solid">
                  <thead>
                    <tr style="border-bottom: 1px dashed;">
                      {{ range $j := until 32 }}
                        {{ $idx := add ($j) (int (mul (float64 $i) (float64 32))) }}
                        {{ $peersPerColumn := index $root.PeerDASInfos.ColumnDistribution (int64 $idx) }}
                        {{ $peerCount := len $peersPerColumn }}
                        <th style="border-right: 1px solid; font-size: 0.8rem;"
                          class="
                          {{ if eq $peerCount 0 }}
                            bg-danger
                            text-light
                          {{ else if lt $peerCount 2 }}
                            bg-warning
                            text-dark
                          {{ end }}">
                          <span class="text-light">{{ $idx }}</span>
                          <div class="dastablepeercount">({{ $peerCount }})</div>
                        </th>
                      {{ end }}
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      {{ range $j := until 32 }}
                        {{ $idx := add ($j) (int (mul (float64 $i) (float64 32))) }}
                        {{ $peersPerColumn := index $root.PeerDASInfos.ColumnDistribution (int64 $idx) }}
                        {{ $peerCount := len $peersPerColumn }}
                        <td style="border-right: 1px solid; vertical-align: top; min-width: 39px;">
                          <div style="display: flex; flex-flow: wrap; margin: 0 auto;">
                          {{ with $peers := $peersPerColumn }}
                            {{ range $i, $p := $peers}}
                              {{ $peerData := index $root.Nodes $p }}
                              <svg class="peer-table-icon dastablenode node-{{ $p }} {{ $peerData.Type}} {{ if $peerData.PeerDAS.IsSuperNode }}supernode{{end}}"
                                   data-jdenticon-value="{{ $p }}"
                                   data-peerid="{{ $p }}" data-alias="{{ $peerData.Alias }}"
                                   data-toggle="tooltip"
                                   data-placement="top"
                                   title="{{ $peerData.Alias }}"
                                   data-animation=false>
                              </svg>
                            {{ end }}
                          {{ end }}
                          </div>
                        </td>
                      {{ end }}
                    </tr>
                </table>
              </div>
              {{ end }}
            </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {{ end }}

    <div class="card mt-2">
      <div class="card-body px-0 py-3">
        <div class="table-responsive table-sorting px-0 py-1">
          <div style="margin-bottom: 15px; padding: 0 15px;">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-search"></i></span>
              <input type="text" class="form-control" id="clientSearchInput" placeholder="Search clients by name...">
              <button class="btn btn-outline-secondary" type="button" id="clearClientSearch">Clear</button>
            </div>
          </div>
          <div style="text-align: right; margin-right: 15px;">
            {{ if and $root.ShowPeerDASInfos (not $root.DisableDasGuardianCheck) $root.EnableDasGuardianMassScan }}
            <button type="button" class="btn btn-outline-primary btn-sm me-3" id="massDasGuardianBtn">
              <i class="fa-solid fa-shield-halved"></i> Mass DAS Guardian Check
            </button>
            {{ end }}
            Peer infos:
            <i class="fa fa-refresh text-muted p-1 mx-1" role="button" data-bs-toggle="tooltip" data-bs-placement="top" title="Refresh peer information" onclick="refreshPeerInfos()" style="cursor: pointer;"></i>
            <div class="btn-group btn-group-sm" role="group" aria-label="Peer info controls">
              <button type="button" id="toggleAllPeers" class="btn btn-outline-secondary" onclick='toggleAllPeers();'>Show all</button>
              <button type="button" id="toggleNodeIds" class="btn btn-outline-secondary" onclick='toggleNodeIds();'>Expand node IDs</button>
            </div>
          </div>
          <table class="table table-nobr" id="clients">
            <thead>
              <tr>
                <th>
                  #
                  <div class="col-sorting">
                    <a href="/clients/consensus?o=index" class="sort-link {{ if eq .Sorting "index" }}active{{ end }}"><i class="fas fa-arrow-up"></i></a>
                    <a href="/clients/consensus?o=index-d" class="sort-link {{ if eq .Sorting "index-d" }}active{{ end }}"><i class="fas fa-arrow-down"></i></a>
                  </div>
                </th>
                <th>
                  Name
                  <div class="col-sorting">
                    <a href="/clients/consensus?o=name" class="sort-link {{ if eq .Sorting "name" }}active{{ end }}"><i class="fas fa-arrow-up"></i></a>
                    <a href="/clients/consensus?o=name-d" class="sort-link {{ if eq .Sorting "name-d" }}active{{ end }}"><i class="fas fa-arrow-down"></i></a>
                  </div>
                </th>
                <th>
                  Peers
                  <div class="col-sorting">
                    <a href="/clients/consensus?o=peers" class="sort-link {{ if eq .Sorting "peers" }}active{{ end }}"><i class="fas fa-arrow-up"></i></a>
                    <a href="/clients/consensus?o=peers-d" class="sort-link {{ if eq .Sorting "peers-d" }}active{{ end }}"><i class="fas fa-arrow-down"></i></a>
                  </div>
                </th>
                <th>
                  Head Slot
                  <div class="col-sorting">
                    <a href="/clients/consensus?o=headslot" class="sort-link {{ if eq .Sorting "headslot" }}active{{ end }}"><i class="fas fa-arrow-up"></i></a>
                    <a href="/clients/consensus?o=headslot-d" class="sort-link {{ if eq .Sorting "headslot-d" }}active{{ end }}"><i class="fas fa-arrow-down"></i></a>
                  </div>
                </th>
                <th>
                  Head Root
                  <div class="col-sorting">
                    <a href="/clients/consensus?o=headroot" class="sort-link {{ if eq .Sorting "headroot" }}active{{ end }}"><i class="fas fa-arrow-up"></i></a>
                    <a href="/clients/consensus?o=headroot-d" class="sort-link {{ if eq .Sorting "headroot-d" }}active{{ end }}"><i class="fas fa-arrow-down"></i></a>
                  </div>
                </th>
                <th>
                  Status
                  <div class="col-sorting">
                    <a href="/clients/consensus?o=status" class="sort-link {{ if eq .Sorting "status" }}active{{ end }}"><i class="fas fa-arrow-up"></i></a>
                    <a href="/clients/consensus?o=status-d" class="sort-link {{ if eq .Sorting "status-d" }}active{{ end }}"><i class="fas fa-arrow-down"></i></a>
                  </div>
                </th>
                <th>
                  Version
                  <div class="col-sorting">
                    <a href="/clients/consensus?o=version" class="sort-link {{ if eq .Sorting "version" }}active{{ end }}"><i class="fas fa-arrow-up"></i></a>
                    <a href="/clients/consensus?o=version-d" class="sort-link {{ if eq .Sorting "version-d" }}active{{ end }}"><i class="fas fa-arrow-down"></i></a>
                  </div>
                </th>
                <th>Actions</th>
              </tr>
            </thead>
              <tbody>
                {{ range $i, $client := .Clients }}
                  <tr>
                    <td>{{ $client.Index }}</td>
                    <td>
                      <svg class="client-node-icon" data-jdenticon-value="{{ $client.PeerID }}"></svg>
                      <span id="clientRow-{{ $client.Name }}" style="cursor:pointer;" class="client-row" data-peerid="{{ $client.PeerID}}">
                        <a href="#name={{ $client.Name }}">{{ $client.Name }}</a>
                      </span>
                    </td>
                    <td style="font-size: 0.8rem; vertical-align: middle;">
                      <span class="client-node-peer-count text-success" data-toggle="tooltip" data-placement="top" title="Inbound Peers">
                        {{ $client.PeersInboundCounter }}
                        <i class="fa-solid fa-arrow-down"></i>
                      </span>
                      <span class="client-node-peer-count text-danger" data-toggle="tooltip" data-placement="top" title="Outbound Peers">
                        {{ $client.PeersOutboundCounter}}
                        <i class="fa-solid fa-arrow-up"></i>
                      </span>
                      <span class="client-node-peer-count" data-toggle="tooltip" data-placement="top" title="Total Peers">
                        ({{ $client.PeerCount }})
                      </span>
                    </td>
                    <td><a href="/slot/{{ $client.HeadSlot }}">{{ formatAddCommas $client.HeadSlot }}</a></td>
                    <td class="text-monospace">
                      <a href="/slot/0x{{ printf "%x" $client.HeadRoot }}" class="text-truncate d-inline-block" style="max-width: 200px">0x{{ printf "%x" $client.HeadRoot }}</a>
                      <i class="fa fa-copy text-muted p-1" role="button" data-toggle="tooltip" title="Copy to clipboard" data-clipboard-text="0x{{ printf "%x" $client.HeadRoot }}"></i>
                    </td>
                    <td>
                      {{ if eq $client.Status "online" }}
                        <span class="badge rounded-pill text-bg-success">Ready</span>
                      {{ else if eq $client.Status "synchronizing" }}
                        <span class="badge rounded-pill text-bg-warning" data-toggle="tooltip" data-placement="top" title="Updated: {{ formatRecentTimeShort $client.LastRefresh }}">Synchronizing</span>
                      {{ else if eq $client.Status "optimistic" }}
                        <span class="badge rounded-pill text-bg-info" data-toggle="tooltip" data-placement="top" title="Updated: {{ formatRecentTimeShort $client.LastRefresh }}">Optimistic</span>
                      {{ else if eq $client.Status "offline" }}
                        <span class="badge rounded-pill text-bg-secondary" data-toggle="tooltip" data-placement="top" title="Updated: {{ formatRecentTimeShort $client.LastRefresh }}, Error: {{ $client.LastError }}">Disconnected</span>
                      {{ else }}
                        <span class="badge rounded-pill text-bg-dark">{{ $client.Status }}</span>
                      {{ end }}
                      <span class="text-warning spec-mismatch-icon" role="button" data-client-name="{{ $client.Name }}"
                        data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true"
                        title="" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                      </span>
                    </td>
                    <td>
                      <span class="text-truncate d-inline-block" style="max-width: 300px">{{ $client.Version }}</span>
                      <i class="fa fa-copy text-muted p-1" role="button" data-toggle="tooltip" title="Copy to clipboard" data-clipboard-text="{{ $client.Version }}"></i>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-outline-secondary show-specs-btn me-1" 
                              data-client-name="{{ $client.Name }}"
                              data-bs-toggle="tooltip" data-bs-html="true"
                              title="">
                        <i class="fa-solid fa-book"></i>
                      </button>
                      {{ if and $client.NodeENR $root.ShowPeerDASInfos (not $root.DisableDasGuardianCheck) }}
                      <button class="btn btn-sm btn-outline-primary das-check-btn" 
                              data-enr="{{ $client.NodeENR }}" 
                              data-client-name="{{ $client.Name }}"
                              data-toggle="tooltip" 
                              title="Run DAS Guardian Check">
                        <i class="fa-solid fa-shield-halved"></i>
                      </button>
                      {{ end }}
                    </td>
                  </tr>
                  <tr class="collapse peerInfo" style="transition:0s" id="peerInfo-{{ $client.PeerID }}">
                    <td colspan="8" style="padding: 10px 0;" class="client-node-peerinfo-container" data-peerid="{{ $client.PeerID }}">


                    </td>
                  </tr>
                {{ end }}
              </tbody>
          </table>
        </div>


        <!-- Peer details template -->
        <div class="peer-details-content d-none">
          <div class="client-row-divider">Node identity</div>
          <div class="client-node-peerinfo">
            <table class="table table-borderless table-sm client-table-info ">
              <tbody>
                <tr>
                  <td>Name</td>
                  <td>
                    <code data-bind="text: alias"></code>
                    <i class="fa fa-copy text-muted p-1" role="button" data-placement="right" data-toggle="tooltip" title="Copy to clipboard" data-bind="attr: {'data-clipboard-text': alias}"></i>
                  </td>
                </tr>
                <tr>
                  <td>Peer ID</td>
                  <td>
                    <code data-bind="text: peer_id"></code>
                    <i class="fa fa-copy text-muted p-1" role="button" data-placement="right" data-toggle="tooltip" title="Copy to clipboard" data-bind="attr: {'data-clipboard-text': peer_id}"></i>
                  </td>
                </tr>
                <tr>
                  <td>Node ID</td>
                  <td>
                    <code data-bind="text: node_id"></code>
                    <i class="fa fa-copy text-muted p-1" role="button" data-placement="right" data-toggle="tooltip" title="Copy to clipboard" data-bind="attr: {'data-clipboard-text': node_id}"></i>
                  </td>
                </tr>
                {{ html "<!-- ko if: showSensitivePeerInfos -->" }}
                <tr style="vertical-align: top;">
                  <td>ENR</td>
                  <td>
                    <code class="enr-text-container" data-bind="text: enr"></code>
                    <i class="fa fa-copy text-muted p-1" role="button" data-placement="right" data-toggle="tooltip" title="Copy to clipboard" data-bind="attr: {'data-clipboard-text': enr}"></i>
                  </td>
                </tr>
                {{ html "<!-- /ko -->" }}
              </tbody>
            </table>
            {{ html "<!-- ko if: showSensitivePeerInfos -->" }}
            <div class="client-row-divider">ENR fields & Metadata</div>
            <div class="row" style="margin-top:10px">
              <!-- ENR fields on the left -->
              <div class="col-md-6">
                <table class="table table-borderless table-sm client-table-info">
                  <tbody>
                    {{ html "<!-- ko foreach: enr_kv -->" }}
                    <tr>
                      <td data-bind="text: key"></td>
                      <td>
                        {{ html "<!-- ko if: key === 'cgc' -->" }}
                        <code data-bind="text: value, attr: {'data-bs-toggle': 'tooltip', 'data-bs-placement': 'right', 'data-bs-title': 'Decimal: ' + window.explorer.hexToDecimal(value)}"></code>
                        {{ html "<!-- /ko -->" }}
                        {{ html "<!-- ko if: key !== 'cgc' -->" }}
                        <code data-bind="text: value"></code>
                        {{ html "<!-- /ko -->" }}
                        <i class="fa fa-copy text-muted p-1" role="button" data-placement="right" data-toggle="tooltip" data-bind="attr: {'data-clipboard-text': $data.value, title: 'Copy ' + $data.key + ' to clipboard'}" ></i>
                      </td>
                    </tr>
                    {{ html "<!-- /ko -->" }}
                  </tbody>
                </table>
              </div>
              <!-- Metadata fields on the right -->
              <div class="col-md-6">
                <table class="table table-borderless table-sm client-table-info">
                  <tbody>
                    {{ html "<!-- ko foreach: metadata_kv -->" }}
                    <tr>
                      <td data-bind="text: key"></td>
                      <td>
                        <code data-bind="text: value"></code>
                        <i class="fa fa-copy text-muted p-1" role="button" data-placement="right" data-toggle="tooltip" data-bind="attr: {'data-clipboard-text': $data.value, title: 'Copy ' + $data.key + ' to clipboard'}" ></i>
                      </td>
                    </tr>
                    {{ html "<!-- /ko -->" }}
                  </tbody>
                </table>
              </div>
            </div>
            {{ html "<!-- /ko -->" }}

            {{ html "<!-- ko if: showPeerDASInfos -->" }}
            <div class="client-row-divider">Peer DAS</div>
            <table class="table table-borderless table-sm client-table-info" style="margin-top:10px">
              <tbody>
                  <tr>
                    <td data-bind="text: 'Custody columns/subnets (' + peer_das().columns.length + ')'"></td>
                    <td>
                      <code class="enr-text-container" data-bind="text: peer_das().columns.join(', ')"></code>
                      <i class="fa fa-copy text-muted p-1" role="button" data-placement="right" data-toggle="tooltip" data-bind="attr: {'data-clipboard-text': peer_das().columns.join(', ')}" title="Copy custody columns to clipboard"></i>
                    </td>
                  </tr>
              </tbody>
            </table>
            {{ html "<!-- /ko -->" }}
          </div>
          <div class="client-row-divider" style="position: relative;">
            Peers
            <button type="button" class="btn btn-outline-secondary btn-sm peer-collapse-btn" data-bs-toggle="collapse" data-bind="attr: {'data-bs-target': '#peer-details-list-' + peer_id(), 'aria-controls': 'peer-details-list-' + peer_id()}" aria-expanded="false" style="position: absolute; right: 0; top: 0;">
              <i class="fa fa-chevron-down"></i> Show Connected Peers
            </button>
          </div>
          <div class="collapse peer-details-collapse" data-bind="attr: {id: 'peer-details-list-' + peer_id()}">
            <div class="peer-table-column">
              {{ html "<!-- ko foreach: peers -->" }}

                <div style="padding-left: 20px; padding-top:3px" data-bind="let: {$node: $root.getNode(peer_id)}">
                  <i class="fa-solid fa-down-long text-success" data-toggle="tooltip" data-placement="left" title="Inbound" data-bind="visible: direction == 'inbound'"></i>
                  <i class="fa-solid fa-up-long text-danger" data-toggle="tooltip" data-placement="left" title="Outbound" data-bind="visible: direction == 'outbound'"></i>
                  <svg data-bind="attr: {'data-jdenticon-value': peer_id}, class: 'peer-table-icon '+state"></svg>
                  <code data-bind="text: peer_id"></code>
                  <i class="fa fa-copy text-muted p-1" role="button" data-toggle="tooltip" title="Copy to clipboard" data-bind="attr: {'data-clipboard-text': peer_id}"></i>
                  <span class="badge text-bg-secondary" data-bind="if: $node.type == 'internal'">
                    <span data-bind="text: $node.alias"></span>
                  </span>
                </div>
                {{ html "<!-- ko if: $root.showSensitivePeerInfos -->" }}
                  <div class="client-node-peer-details" data-bind="let: {$node: $root.getNode(peer_id)}">
                    {{ html "<!-- ko if: $node.enr != enr -->" }}
                      <div style="padding:10px; margin: 0; margin-left:10px; margin-right: 25px; word-break: break-all; text-wrap: pretty;" class="alert alert-warning" role="alert">
                        <p>
                          <i class="fa-solid fa-circle-exclamation" style="margin-right: 10px;"></i>The ENR information was obtained from another node.
                        </p>
                        <p>
                          The node <code data-bind="text: $root.getNodeName($parent.peer_id)"></code> did not have the most up-to-date ENR for this peer.
                          {{ html "<!-- ko if: enr == '' -->" }}
                            The reported ENR was empty (nil).
                          {{ html "<!-- /ko -->" }}
                        </p>
                        {{ html "<!-- ko if: enr != '' -->" }}
                          <p>Some other node reported a higher sequence number than this one.
                            <code data-bind="text: 'seq=' + $root.getEnrValue(enr_kv, 'seq')"></code> vs <code data-bind="text: 'seq=' + $root.getEnrValue($node.enr_kv, 'seq')"></code>
                          </p>
                          <p>ENR: <code data-bind="text: enr"></code></p>
                          <p>Decoded ENR: <code data-bind="text: $root.getEnrJson(enr_kv)"></code></p>
                        {{ html "<!-- /ko -->" }}


                      </div>
                    {{ html "<!-- /ko -->" }}

                    <table class="table table-borderless table-sm client-table-info" style="padding-left:0; margin-top:10px;margin-bottom: 10px; margin-left: 10px;">
                      <tbody>
                        <tr>
                          <td>Node ID</td>
                          <td>
                            <code data-bind="text: $node.node_id"></code>
                            <i class="fa fa-copy text-muted p-1" role="button" data-placement="right" data-toggle="tooltip" title="Copy to clipboard" data-bind="attr: {'data-clipboard-text': $node.node_id}"></i>
                          </td>
                        </tr>
                        <tr>
                          <td>P2P Addr</td>
                          <td>
                            <code data-bind="text: last_seen_p2p_address"></code>
                            <i class="fa fa-copy text-muted p-1" role="button" data-placement="right" data-toggle="tooltip" title="Copy to clipboard" data-bind="attr: {'data-clipboard-text': last_seen_p2p_address}"></i>
                          </td>
                        </tr>
                        <tr>
                          <td>ENR</td>
                          <td>
                            <code class="enr-text-container" data-bind="text: $node.enr"></code>
                            <i class="fa fa-copy text-muted p-1" role="button" data-placement="right" data-toggle="tooltip" title="Copy to clipboard" data-bind="attr: {'data-clipboard-text': enr || $node.enr}"></i>
                          </td>
                        </tr>
                        {{ html "<!-- ko if: $node.enr != '' -->" }}
                        {{ html "<!-- ko foreach: $node.enr_kv -->" }}
                          <tr>
                            <td data-bind="text: key"></td>
                            <td>
                              <code data-bind="text: value"></code>
                              <i class="fa fa-copy text-muted p-1" role="button" data-placement="right" data-toggle="tooltip" data-bind="attr: {'data-clipboard-text': value, title: 'Copy ' + key + ' to clipboard'}"></i>
                            </td>
                          </tr>
                        {{ html "<!-- /ko -->" }}
                        {{ html "<!-- /ko -->" }}
                      </tbody>
                    </table>
                    {{ html "<!-- ko if: $root.showPeerDASInfos -->" }}
                      <div class="client-row-divider">Peer DAS</div>
                      <table class="table table-borderless table-sm client-table-info" style="padding-left:0; margin-top:10px;margin-bottom: 10px; margin-left: 10px;">
                        <tbody>
                            <tr>
                              <td data-bind="text: 'Custody columns/subnets (' + $node.peer_das.columns.length + ')'"></td>
                              <td>
                                <code class="enr-text-container" data-bind="text: $node.peer_das.columns.join(', ')"></code>
                                <i class="fa fa-copy text-muted p-1" role="button" data-placement="right" data-toggle="tooltip" title="Copy to clipboard" data-bind="attr: {'data-clipboard-text': $node.peer_das.columns.join(', ')}" ></i>
                              </td>
                            </tr>
                        </tbody>
                      </table>
                    {{ html "<!-- /ko -->" }}
                  </div>
                {{ html "<!-- /ko -->" }}
              {{ html "<!-- /ko -->" }}
            </div>
          </div>
        </div>

        <!-- Peer details modal -->
        <div class="modal modal-xl" id="peerDetailsModal" tabindex="-1" role="dialog" aria-labelledby="peerDetailsModalTitle" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" style="overflow-wrap: anywhere;">
                  <svg id="peerDetailsModalTitleImage" class="peer-table-icon" style="width:50px;height:50px;" data-jdenticon-value="user127"></svg>
                  <span id="peerDetailsModalTitle"></span>
                </h5>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"  onclick="hidePeerDetailsModal()"></button>
              </div>
              <div class="modal-body">
                <div id="peerDetailsModalBody">
                  <table class="table table-borderless table-sm">
                    <tr>
                      <td style="min-width:90px;">Peer ID</td>
                      <td><code data-bind="text: peer_id"></code></td>
                    </tr>
                    <tr>
                      <td>Node ID</td>
                      <td><code data-bind="text: node_id"></code></td>
                    </tr>
                    {{ html "<!-- ko if: $root.showSensitivePeerInfos -->" }}
                      <tr>
                        <td>ENR</td>
                        <td><code class="enr-text-container" data-bind="text: !$root.showSensitivePeerInfos ? '***' : enr ? enr : 'Unknown'"></code></td>
                      </tr>
                      {{ html "<!-- ko if: enr != '' -->" }}
                        <tr>
                          <td colspan="2" style="font-weight: 700;padding-top: 5px;padding-bottom: 5px; text-align: center;border-top:1px dashed; border-bottom:1px dashed">ENR Fields</td>
                        </tr>
                        {{ html "<!-- ko foreach: enr_kv -->" }}
                          <tr>
                            <td style="padding-right:15px; vertical-align:top" data-bind="text: key"></td>
                            <td><code class="enr-text-container" data-bind="text: value"></code></td>
                          </tr>
                        {{ html "<!-- /ko -->" }}
                      {{ html "<!-- /ko -->" }}
                    {{ html "<!-- /ko -->" }}
                    {{ html "<!-- ko if: $root.showPeerDASInfos -->" }}
                      <tr>
                        <td colspan="2" style="font-weight: 700;padding-top: 5px;padding-bottom: 5px; text-align: center;border-top:1px dashed; border-bottom:1px dashed">Peer DAS</td>
                      </tr>
                      <tr>
                        <td>Supernode</td>
                        <td><code data-bind="text: peer_das().is_super_node"></code></td>
                      </tr>
                      <tr>
                        <td>CGC</td>
                        <td><code data-bind="text: peer_das().cgc"></code></td>
                      </tr>
                      <tr>
                        <td data-bind="text: 'Columns/subnets (' + peer_das().columns.length + ')'"></td>
                        <td><code class="enr-text-container" data-bind="text: peer_das().columns.join(', ')"></code></td>
                      </tr>
                    {{ html "<!-- /ko -->" }}
                    <tr>
                      <td colspan="2" style="font-weight: 700;padding-top: 5px;padding-bottom: 5px; text-align: center;border-top:1px dashed; border-bottom:1px dashed">Peers</td>
                    </tr>

                    {{ html "<!-- ko if: peers_in != null -->" }}
                      {{ html "<!-- ko foreach: peers_in -->" }}
                        <tr>
                          <td colspan="2">
                            <i class="fa-solid fa-down-long text-success" data-toggle="tooltip" data-placement="left" title="Inbound"></i>
                            <svg class="peer-table-icon peer-details-jdenticon" data-bind="attr: {'data-jdenticon-value': $data}"></svg>
                            <span class="peerdetails-modal-peer" onclick="showPeerDetailsModal($(this).data('peerid'))" data-bind="attr: {'data-peerid': $data}, let: {peer: $root.getNode($data)}">
                              <code data-bind="text: $data"></code>
                              {{ html "<!-- ko if: peer.alias != $data -->" }}
                                <span class="badge text-bg-secondary">
                                  <span data-bind="text: peer.alias"></span>
                                </span>
                              {{ html "<!-- /ko -->" }}
                            </span>
                          </td>
                        </tr>
                      {{ html "<!-- /ko -->" }}
                    {{ html "<!-- /ko -->" }}

                    {{ html "<!-- ko if: peers_out != null -->" }}
                      {{ html "<!-- ko foreach: peers_out -->" }}
                        <tr>
                          <td colspan="2">
                            <i class="fa-solid fa-up-long text-danger" data-toggle="tooltip" data-placement="left" title="Outbound"></i>
                            <svg class="peer-table-icon peer-details-jdenticon" data-bind="attr: {'data-jdenticon-value': $data}"></svg>
                            <span class="peerdetails-modal-peer" onclick="showPeerDetailsModal($(this).data('peerid'))" data-bind="attr: {'data-peerid': $data}, let: {peer: $root.getNode($data)}">
                              <code data-bind="text: $data"></code>
                              {{ html "<!-- ko if: peer.alias != $data -->" }}
                                <span class="badge text-bg-secondary">
                                  <span data-bind="text: peer.alias"></span>
                                </span>
                              {{ html "<!-- /ko -->" }}
                            </span>
                          </td>
                        </tr>
                      {{ html "<!-- /ko -->" }}
                    {{ html "<!-- /ko -->" }}
                  </table>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="hidePeerDetailsModal()">Close</button>
              </div>
            </div>
          </div>
        </div>

        <!-- DAS Guardian Modal -->
        {{ if and $root.ShowPeerDASInfos (not $root.DisableDasGuardianCheck) }}
        <div class="modal fade" id="dasGuardianModal" tabindex="-1" role="dialog" aria-labelledby="dasGuardianModalTitle" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="dasGuardianModalTitle">
                  <i class="fa-solid fa-shield-halved"></i> DAS Guardian Check - <span id="dasGuardianClientName"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" id="dasGuardianModalBody">
                <!-- Scan Options -->
                <div id="dasGuardianOptions">
                  <div class="alert alert-info">
                    <i class="fa-solid fa-info-circle"></i> DAS Guardian scans are resource-intensive operations. Nodes may temporarily ban the scanner after use.
                  </div>
                  
                  <h6>Scan Options</h6>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="scanType" id="scanRandomSlots" value="random" checked>
                    <label class="form-check-label" for="scanRandomSlots">
                      <strong>Scan Random Slots</strong> - Validate DAS columns for randomly selected slots
                    </label>
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="scanType" id="scanWithSlots" value="slots">
                    <label class="form-check-label" for="scanWithSlots">
                      <strong>Scan Specific Slots</strong> - Validate DAS columns for selected slots
                    </label>
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="scanType" id="scanMetadataOnly" value="metadata">
                    <label class="form-check-label" for="scanMetadataOnly">
                      <strong>Metadata Only</strong> - Quick scan for node status and custody information (no DAS column validation)
                    </label>
                  </div>
                  
                  <!-- Slot Selection (hidden by default) -->
                  <div id="slotSelectionSection" style="display: none;" class="mt-3 p-3 border rounded">
                    <h6>Select Slots to Scan</h6>
                    <div class="input-group mb-3">
                      <input type="text" class="form-control" id="slotInput" placeholder="Enter slot number or root">
                      <button class="btn btn-outline-secondary" type="button" id="addSlotBtn">
                        <i class="fa-solid fa-plus"></i> Add Slot
                      </button>
                    </div>
                    <div id="selectedSlotsList">
                      <!-- Selected slots will appear here -->
                    </div>
                  </div>
                  
                  <!-- Random Slot Selection (shown by default since random is now default) -->
                  <div id="randomSlotSelectionSection" class="mt-3 p-3 border rounded">
                    <h6>Random Slot Selection Mode</h6>
                    <div class="form-check mb-2">
                      <input class="form-check-input" type="radio" name="randomMode" id="randomWithBlobs" value="with_blobs" checked>
                      <label class="form-check-label" for="randomWithBlobs">
                        <strong>Random Slots with Blobs</strong> - Select from slots that contain blob transactions
                      </label>
                    </div>
                    <div class="form-check mb-2">
                      <input class="form-check-input" type="radio" name="randomMode" id="randomNonMissed" value="non_missed">
                      <label class="form-check-label" for="randomNonMissed">
                        <strong>Random Non-Missed Slots</strong> - Select from slots that have proposed blocks
                      </label>
                    </div>
                    <div class="form-check mb-3">
                      <input class="form-check-input" type="radio" name="randomMode" id="randomAvailable" value="available">
                      <label class="form-check-label" for="randomAvailable">
                        <strong>Random Available Slots</strong> - Select from all available slots for DAS validation
                      </label>
                    </div>
                    <div class="mb-3">
                      <label for="randomSlotCount" class="form-label">Number of slots to select (4-5 recommended):</label>
                      <input type="number" class="form-control" id="randomSlotCount" min="1" max="10" value="4">
                    </div>
                  </div>
                  
                  <div class="mt-4">
                    <button type="button" class="btn btn-primary" id="startScanBtn">
                      <i class="fa-solid fa-play"></i> Start Scan
                    </button>
                  </div>
                </div>
                
                <!-- Loading indicator (hidden by default) -->
                <div class="text-center" id="dasGuardianLoading" style="display: none;">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-3">Running DAS Guardian scan...</p>
                </div>
                
                <!-- Results (hidden by default) -->
                <div id="dasGuardianResults" style="display: none;">
                  <!-- Results will be populated here -->
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
        {{ end }}

        <!-- Mass DAS Guardian Modal -->
        {{ if and $root.ShowPeerDASInfos (not $root.DisableDasGuardianCheck) $root.EnableDasGuardianMassScan }}
        <div class="modal fade" id="massDasGuardianModal" tabindex="-1" role="dialog" aria-labelledby="massDasGuardianModalTitle" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-xl mass-das-modal-extra-wide" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="massDasGuardianModalTitle">
                  <i class="fa-solid fa-shield-halved"></i> Mass DAS Guardian Check
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" id="massDasGuardianModalBody">
                <!-- Slot Selection -->
                <div id="massDasGuardianSlotSelection">
                  <div class="alert alert-info">
                    <i class="fa-solid fa-info-circle"></i> Mass DAS Guardian scans will test all available nodes in parallel. This operation may take several minutes.
                  </div>
                  
                  <h6>Select Slots to Test</h6>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="massScanType" id="massRandomSlots" value="random" checked>
                    <label class="form-check-label" for="massRandomSlots">
                      <strong>Random Slots</strong> - Test randomly selected slots
                    </label>
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="massScanType" id="massSpecificSlots" value="slots">
                    <label class="form-check-label" for="massSpecificSlots">
                      <strong>Specific Slots</strong> - Test manually selected slots
                    </label>
                  </div>
                  
                  <!-- Random Slot Selection -->
                  <div id="massRandomSlotSection" class="mt-3 p-3 border rounded">
                    <h6>Random Slot Selection</h6>
                    <div class="form-check mb-2">
                      <input class="form-check-input" type="radio" name="massRandomMode" id="massRandomWithBlobs" value="with_blobs" checked>
                      <label class="form-check-label" for="massRandomWithBlobs">
                        <strong>Random Slots with Blobs</strong> - Select from slots that contain blob transactions
                      </label>
                    </div>
                    <div class="form-check mb-2">
                      <input class="form-check-input" type="radio" name="massRandomMode" id="massRandomNonMissed" value="non_missed">
                      <label class="form-check-label" for="massRandomNonMissed">
                        <strong>Random Non-Missed Slots</strong> - Select from slots that have proposed blocks
                      </label>
                    </div>
                    <div class="form-check mb-3">
                      <input class="form-check-input" type="radio" name="massRandomMode" id="massRandomAvailable" value="available">
                      <label class="form-check-label" for="massRandomAvailable">
                        <strong>Random Available Slots</strong> - Select from all available slots
                      </label>
                    </div>
                    <div class="mb-3">
                      <label for="massRandomSlotCount" class="form-label">Number of slots to test (3-5 recommended):</label>
                      <input type="number" class="form-control" id="massRandomSlotCount" min="1" max="10" value="4">
                    </div>
                  </div>
                  
                  <!-- Specific Slot Selection -->
                  <div id="massSpecificSlotSection" style="display: none;" class="mt-3 p-3 border rounded">
                    <h6>Select Specific Slots</h6>
                    <div class="input-group mb-3">
                      <input type="text" class="form-control" id="massSlotInput" placeholder="Enter slot number or root">
                      <button class="btn btn-outline-secondary" type="button" id="massAddSlotBtn">
                        <i class="fa-solid fa-plus"></i> Add Slot
                      </button>
                    </div>
                    <div id="massSelectedSlotsList">
                      <!-- Selected slots will appear here -->
                    </div>
                  </div>
                  
                  <div class="mt-4">
                    <button type="button" class="btn btn-primary" id="startMassScanBtn">
                      <i class="fa-solid fa-play"></i> Start Mass Scan
                    </button>
                  </div>
                </div>
                
                <!-- Loading indicator (hidden by default) -->
                <div class="text-center" id="massDasGuardianLoading" style="display: none;">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-3">Running mass DAS Guardian scan...</p>
                  <div id="massLoadingProgress" class="mt-3">
                    <div class="progress">
                      <div class="progress-bar" role="progressbar" style="width: 0%" id="massProgressBar"></div>
                    </div>
                    <small class="text-muted mt-2" id="massProgressText">Initializing...</small>
                  </div>
                </div>
                
                <!-- Results (hidden by default) -->
                <div id="massDasGuardianResults" style="display: none;">
                  <!-- Results grid will be populated here -->
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
        {{ end }}

        <!-- Spec Mismatch Modal -->
        <div class="modal fade" id="specMismatchModal" tabindex="-1" role="dialog" aria-labelledby="specMismatchModalTitle" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered config-modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="specMismatchModalTitle">
                  <i class="fas fa-code-compare text-warning me-2"></i>Configuration Comparison: <span id="specMismatchModalClientName"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" id="specMismatchModalBody">
                <!-- Content will be populated dynamically -->
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>

      </div>

      <div id="footer-placeholder" style="height:30px;"></div>
    </div>
  </div>

{{ end }}

{{ define "js" }}
<script src="/js/vendor/jdenticon-3.3.0.min.js"></script>
<script src="/js/knockout.min.js"></script>
<script src="/js/vendor/cytoscape.min.js"></script>
<script src="/js/vendor/cytoscape-layout-base.js"></script>
<script src="/js/vendor/cytoscape-cose-base.js"></script>
<script src="/js/vendor/cytoscape-fcose.js"></script>
<script src="/js/cytoscape-network-aux.js"></script>
<script type="text/javascript">
  var peerGraphData = {{ .PeerMap }};
  var peerGraph, peerGraphRendered = false;

  var nodes = {{ .Nodes }};

  function renderPeerGraph() {
    var container = document.getElementById("nodemap");
    peerGraph = $_network.create(container, peerGraphData);
  }

  // Always keep graph collapsed by default - render only when opened
  $('#peerGraph').on('shown.bs.collapse', function () {
    if(peerGraphRendered) return;
    renderPeerGraph();
    peerGraphRendered = true;
  });


  var lastClickedNode = null;

  // PeerDASTable Filter
  function filterDASTablePeers() {
    // Get the status of each checkbox
    var showExternal = $('#showExternalPeersDAS').is(':checked');
    var showInternal = $('#showInternalPeersDAS').is(':checked');
    var showSupernode = $('#showSupernodePeersDAS').is(':checked');

    console.log(showExternal, showInternal, showSupernode);

    // For each node, show or hide based on the filter status
    $('.dastablenode').each(function() {
      var isExternal = $(this).hasClass('external');
      var isInternal = $(this).hasClass('internal');
      var isSupernode = $(this).hasClass('supernode');


      console.log(isExternal, isInternal, isSupernode);

      // Show supernodes if the checkbox is checked
      if (isSupernode && showSupernode) {
        $(this).show();
        return;
      } else if (isSupernode && !showSupernode) {
        $(this).hide();
        return;
      }

      // Show the node if it matches any of the active types
      if ((showExternal && isExternal) ||
          (showInternal && isInternal)) {
        $(this).show();
      } else {
        $(this).hide();
      }

    });

    // Update column counts and coloring based on visible peers
    updateColumnCounts();
  }

  // Function to update column counts and header coloring based on visible peers
  function updateColumnCounts() {
    // For each column, count visible peers and update header styling
    $('table thead th').each(function() {
      var columnHeader = $(this);
      var columnIndex = columnHeader.find('span').text(); // Get column number from span
      
      if (columnIndex) {
        // Find the corresponding table cell in the same column
        var columnCell = columnHeader.closest('table').find('tbody td').eq(columnHeader.index());
        
        // Count visible peers in this column
        var visiblePeerCount = columnCell.find('.dastablenode:visible').length;
        
        // Update the count display
        columnHeader.find('.dastablepeercount').text('(' + visiblePeerCount + ')');
        
        // Remove existing background classes
        columnHeader.removeClass('bg-danger bg-warning text-light text-dark');
        
        // Apply new coloring based on visible peer count
        if (visiblePeerCount === 0) {
          columnHeader.addClass('bg-danger text-light');
        } else if (visiblePeerCount < 2) {
          columnHeader.addClass('bg-warning text-dark');
        }
      }
    });
  }

  // PeerDAS search and clear handlers (always active)
  $('#searchDASTablePeers').on('input', function() {
    var searchText = $(this).val();
    if(searchText) searchText = searchText.trim().toLowerCase();

    if (searchText) {
      $('.dastablenode').each(function() {
        const peerId = $(this).data('peerid').toString().toLowerCase();
        const alias = $(this).data('alias').toString().toLowerCase();
        if (peerId.includes(searchText) || alias.includes(searchText)) {
          $(this).addClass('highlight').removeClass('blur');
        } else {
          $(this).addClass('blur').removeClass('highlight');
        }
      });
    } else {
      $('.dastablenode').removeClass('blur highlight');
    }
  });

  $('#clearSearchButton').click(function(){
    $('#searchDASTablePeers').val('');
    $('.dastablenode').removeClass('blur highlight');
  });

  // Event listener to remove highlight when clicking outside (always active)
  $(document).on('click', function(event) {
    var searchText = $('#searchDASTablePeers').val();
    if(searchText) searchText = searchText.trim().toLowerCase();

    if (!searchText && !$(event.target).closest('.dastablenode').length) {
      $('.dastablenode').removeClass('highlight blur');
      lastClickedNode = null;
    }
  });

  // Client search functionality
  $('#clientSearchInput').on('input', function() {
    var searchText = $(this).val().trim().toLowerCase();

    $('#clients tbody tr').each(function() {
      if (!$(this).hasClass('peerInfo')) {
        var clientName = $(this).find('.client-row a').text().toLowerCase();
        var peerInfoRow = $(this).next('.peerInfo');

        if (searchText === '' || clientName.includes(searchText)) {
          $(this).show();
          peerInfoRow.css('display', '');
        } else {
          $(this).hide();
          peerInfoRow.css('display', 'none');
        }
      }
    });
  });

  $('#clearClientSearch').click(function() {
    $('#clientSearchInput').val('');
    $('#clients tbody tr').each(function() {
      if (!$(this).hasClass('peerInfo')) {
        $(this).show();
        $(this).next('.peerInfo').css('display', '');
      }
    });
  });

  $('.client-row').on('click', function() {
    var peerId = $(this).data('peerid');
    if(peerGraph) {
      $_network.isolateNode(peerGraph, peerId);
    }
    $('.collapse.peerInfo').collapse('hide');
    $('#peerInfo-' + peerId).collapse('show');
  });

  (function() {
    // shared base model for knockout bindings
    var baseModel = {
      showSensitivePeerInfos: {{ .ShowSensitivePeerInfos }},
      showPeerDASInfos: {{ .ShowPeerDASInfos }},
      getNode: function(peerId) { return nodes[peerId] },
      getNodeName: function(peerId) { return nodes[peerId] ? nodes[peerId].alias : "" },
      getEnrValue: function(enr_kv, key) {
        for(var i = 0; i < enr_kv.length; i++) {
          if(enr_kv[i].key == key)
            return enr_kv[i].value;
        }
        return "";
      },
      getEnrJson: function(enr_kv) {
        var obj = {};
        for(var i = 0; i < enr_kv.length; i++) {
          obj[enr_kv[i].key] = enr_kv[i].value;
        }
        return JSON.stringify(obj);
      }
    };

    // Peer details view model
    (function() {
      function createModel(data) {
        var viewModel = Object.create(baseModel);
        var val;
        for(var prop in data) {
          val = data[prop];
          if(Array.isArray(val))
            viewModel[prop] = ko.observableArray(val);
          else
            viewModel[prop] = ko.observable(val);
        }
        return viewModel;
      }

      $('.peerInfo').on('shown.bs.collapse', function () {
        var detailsContainer = $(this).find('.client-node-peerinfo-container');
        if(detailsContainer.data('loaded')) return;

        var peerId = detailsContainer.data('peerid');
        detailsContainer.data('loaded', true);
        var template = $(".peer-details-content").html();
        detailsContainer.html(template);

        var viewModel = createModel(nodes[peerId]);
        ko.applyBindings(viewModel, detailsContainer.get(0));
        window.explorer.initControls();
        jdenticon.update(".peer-table-icon",null);
        
        // Initialize peer collapse handlers for this instance
        initPeerCollapseHandlers(detailsContainer);
      });

    })();

    // Peer details modal view model
    (function() {
      var currentModel = null;

      function createModel(data) {
        var viewModel = Object.create(baseModel);
        var val;
        for(var prop in data) {
          val = data[prop];
          if(Array.isArray(val))
            viewModel[prop] = ko.observableArray(val);
          else
            viewModel[prop] = ko.observable(val);
        }
        return viewModel;
      }

      function updateModel(data) {
        if(!currentModel) {
          currentModel = createModel(data);
          var detailsContainer = $("#peerDetailsModalBody");
          ko.applyBindings(currentModel, detailsContainer.get(0));
          window.explorer.initControls();
        } else {
          for(var prop in data) {
            if(typeof currentModel[prop] == "function") {
              if(currentModel[prop] instanceof ko.observableArray)
                currentModel[prop](data[prop]||[]);
              else
                currentModel[prop](data[prop]);
            } else
              currentModel[prop] = data[prop];
          }
        }
      }

      window.showPeerDetailsModal = function(peerId) {
        if(!peerId) {
          peerId = $(this).data('peerid');
        }

        updateModel(nodes[peerId]);
        jdenticon.update("#peerDetailsModalTitleImage", peerId);
        jdenticon.update(".peer-details-jdenticon",null)

        $("#peerDetailsModal").modal('show');
      };

      window.hidePeerDetailsModal = function() {
        $("#peerDetailsModal").modal('hide');
      };

    })();
  })();

  // Spec mismatch modal
  (function() {
    // Store expected spec data only
    window.expectedSpec = JSON.parse({{ includeJSON .ExpectedChainSpec false }});
    window.expectedConfigFields = JSON.parse({{ includeJSON .ExpectedConfigFields false }});
    window.expectedPresetFields = JSON.parse({{ includeJSON .ExpectedPresetFields false }});
    window.expectedDomainTypeFields = JSON.parse({{ includeJSON .ExpectedDomainTypeFields false }});

    // Initialize tooltips for spec mismatch icons and show specs buttons
    $(document).ready(function() {
      $('.spec-mismatch-icon, .show-specs-btn').each(function() {
        var clientName = $(this).data('client-name');
        var client = null;
        
        // Find the client
        for (var nodeId in nodes) {
          if (nodes[nodeId].alias === clientName) {
            client = nodes[nodeId];
            break;
          }
        }
        
        if (client && client.client_specs) {
          var summary = calculateSpecSummary(window.expectedSpec, client.client_specs);
          var tooltipContent = '';
          
          if ($(this).hasClass('spec-mismatch-icon')) {
            // Only show warning icon if there are missing or mismatched values
            if (summary.missingCount > 0 || summary.mismatchCount > 0) {
              $(this).show();
              
              tooltipContent = '<strong>Spec Mismatch Detected</strong><br/>';
              tooltipContent += summary.missingCount + ' missing, ';
              tooltipContent += summary.mismatchCount + ' mismatched, ';
              tooltipContent += summary.untrackedCount + ' additional untracked fields<br/>';
              tooltipContent += '<em>Click for details.</em>';
              
              $(this).attr('title', tooltipContent);
            }
          } else {
            tooltipContent = '<strong>Show spec values</strong><br/>';
            tooltipContent += summary.missingCount + ' missing, ';
            tooltipContent += summary.mismatchCount + ' mismatched, ';
            tooltipContent += summary.untrackedCount + ' additional untracked fields<br/>';
            tooltipContent += '<em>Click for details.</em>';
            
            $(this).attr('title', tooltipContent);
          }
        }
      });
      
      // Initialize Bootstrap tooltips
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('.spec-mismatch-icon[data-bs-toggle="tooltip"], .show-specs-btn[data-bs-toggle="tooltip"]'));
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
    });

    // Click handler for spec mismatch icons
    $(document).on('click', '.spec-mismatch-icon', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      var clientName = $(this).data('client-name');
      var client = null;
      
      // First try to find by PeerID if it exists
      for (var nodeId in nodes) {
        if (nodes[nodeId].alias === clientName) {
          client = nodes[nodeId];
          break;
        }
      }
      
      if (client && client.client_specs) {
        showSpecMismatchModal(client);
      }
    });

    // Click handler for show specs buttons
    $(document).on('click', '.show-specs-btn', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      var clientName = $(this).data('client-name');
      var client = null;
      
      // First try to find by PeerID if it exists
      for (var nodeId in nodes) {
        if (nodes[nodeId].alias === clientName) {
          client = nodes[nodeId];
          break;
        }
      }
      
      if (client && client.client_specs) {
        showSpecMismatchModal(client);
      }
    });

    function showSpecMismatchModal(client) {
      $('#specMismatchModalClientName').text(client.alias);
      var modalBody = $('#specMismatchModalBody');
      
      // Calculate summary statistics
      var summary = calculateSpecSummary(window.expectedSpec, client.client_specs);
      
      var html = '<h6>Configuration comparison between client and expected network settings:</h6>';
      
      // Add summary section
      html += '<div class="alert alert-info" role="alert">';
      html += '<i class="fas fa-info-circle me-2"></i>';
      html += '<strong>Summary:</strong> ';
      html += summary.missingCount + ' missing, ';
      html += summary.mismatchCount + ' mismatched, ';
      html += summary.untrackedCount + ' additional untracked fields';
      html += '</div>';
      
      // Create comparison sections
      if (window.expectedConfigFields && window.expectedConfigFields.length > 0) {
        html += createSpecComparisonSection('Configuration', window.expectedConfigFields, window.expectedSpec, client.client_specs);
      }
      
      if (window.expectedPresetFields && window.expectedPresetFields.length > 0) {
        html += createSpecComparisonSection('Preset Values', window.expectedPresetFields, window.expectedSpec, client.client_specs);
      }
      
      if (window.expectedDomainTypeFields && window.expectedDomainTypeFields.length > 0) {
        html += createSpecComparisonSection('Domain Types', window.expectedDomainTypeFields, window.expectedSpec, client.client_specs);
      }
      
      // Add untracked fields section
      html += createUntrackedFieldsSection(window.expectedSpec, client.client_specs);
      
      modalBody.html(html);
      var modalElement = document.getElementById('specMismatchModal');
      var modal = new bootstrap.Modal(modalElement);
      modal.show();
    }
    
    // Helper function to compare values with type normalization
    function valuesMatch(value1, value2) {
      if (value1 === value2) {
        return true;
      }

      var isNumericString = function(val) {
        return typeof val === 'string' && !isNaN(val) && !isNaN(parseFloat(val));
      };

      var normalizeValue = function(val) {
        if (val === null || val === undefined) {
          return val;
        }
        if (typeof val === 'number') {
          return val;
        }
        if (isNumericString(val)) {
          return parseFloat(val);
        }
        return val;
      };

      var normalized1 = normalizeValue(value1);
      var normalized2 = normalizeValue(value2);

      if (normalized1 === normalized2) {
        return true;
      }

      return JSON.stringify(value1) === JSON.stringify(value2);
    }

    // Calculate summary statistics for spec comparison
    function calculateSpecSummary(expectedSpecs, clientSpecs) {
      var missingCount = 0;
      var mismatchCount = 0;
      var untrackedCount = 0;
      
      // Count missing and mismatched values in config fields
      if (window.expectedConfigFields) {
        window.expectedConfigFields.forEach(function(field) {
          if (field === 'BLOB_SCHEDULE') {
            // Special handling for blob schedule - compare individual entries
            var expectedSchedule = expectedSpecs ? expectedSpecs['BLOB_SCHEDULE'] : undefined;
            var clientSchedule = clientSpecs ? clientSpecs['BLOB_SCHEDULE'] : undefined;
            
            if (!clientSchedule && expectedSchedule) {
              missingCount++;
            } else if (expectedSchedule && clientSchedule) {
              // Compare each entry in the schedules
              var maxLength = Math.max(
                Array.isArray(expectedSchedule) ? expectedSchedule.length : 0,
                Array.isArray(clientSchedule) ? clientSchedule.length : 0
              );
              
              for (var i = 0; i < maxLength; i++) {
                var expectedEntry = (Array.isArray(expectedSchedule) && i < expectedSchedule.length) ? expectedSchedule[i] : null;
                var clientEntry = (Array.isArray(clientSchedule) && i < clientSchedule.length) ? clientSchedule[i] : null;
                
                // Check EPOCH
                var expectedEpoch = expectedEntry ? expectedEntry.EPOCH : undefined;
                var clientEpoch = clientEntry ? clientEntry.EPOCH : undefined;
                
                if (expectedEpoch !== undefined && (clientEpoch === undefined || clientEpoch === null)) {
                  missingCount++;
                } else if (expectedEpoch !== undefined && clientEpoch !== undefined && expectedEpoch !== clientEpoch) {
                  mismatchCount++;
                }
                
                // Check MAX_BLOBS_PER_BLOCK
                var expectedBlobs = expectedEntry ? expectedEntry.MAX_BLOBS_PER_BLOCK : undefined;
                var clientBlobs = clientEntry ? clientEntry.MAX_BLOBS_PER_BLOCK : undefined;
                
                if (expectedBlobs !== undefined && (clientBlobs === undefined || clientBlobs === null)) {
                  missingCount++;
                } else if (expectedBlobs !== undefined && clientBlobs !== undefined && expectedBlobs !== clientBlobs) {
                  mismatchCount++;
                }
              }
            }
          } else {
            var expectedValue = expectedSpecs ? expectedSpecs[field] : undefined;
            var clientValue = clientSpecs ? clientSpecs[field] : undefined;
            
            if ((expectedValue !== undefined) && (clientValue === undefined || clientValue === null)) {
              missingCount++;
            } else if (expectedValue !== undefined && clientValue !== undefined && !valuesMatch(clientValue, expectedValue)) {
              mismatchCount++;
            }
          }
        });
      }
      
      // Count missing and mismatched values in preset fields
      if (window.expectedPresetFields) {
        window.expectedPresetFields.forEach(function(field) {
          var expectedValue = expectedSpecs ? expectedSpecs[field] : undefined;
          var clientValue = clientSpecs ? clientSpecs[field] : undefined;

          if ((expectedValue !== undefined) && (clientValue === undefined || clientValue === null)) {
            missingCount++;
          } else if (expectedValue !== undefined && clientValue !== undefined && !valuesMatch(clientValue, expectedValue)) {
            mismatchCount++;
          }
        });
      }
      
      // Count missing and mismatched values in domain type fields
      if (window.expectedDomainTypeFields) {
        window.expectedDomainTypeFields.forEach(function(field) {
          var expectedValue = expectedSpecs ? expectedSpecs[field] : undefined;
          var clientValue = clientSpecs ? clientSpecs[field] : undefined;

          if ((expectedValue !== undefined) && (clientValue === undefined || clientValue === null)) {
            missingCount++;
          } else if (expectedValue !== undefined && clientValue !== undefined && !valuesMatch(clientValue, expectedValue)) {
            mismatchCount++;
          }
        });
      }
      
      // Count untracked fields
      if (clientSpecs) {
        Object.keys(clientSpecs).forEach(function(field) {
          var isInConfig = window.expectedConfigFields && window.expectedConfigFields.indexOf(field) !== -1;
          var isInPreset = window.expectedPresetFields && window.expectedPresetFields.indexOf(field) !== -1;
          var isInDomainTypes = window.expectedDomainTypeFields && window.expectedDomainTypeFields.indexOf(field) !== -1;
          var isInExpected = expectedSpecs && expectedSpecs.hasOwnProperty(field);
          
          if (!isInConfig && !isInPreset && !isInDomainTypes && !isInExpected) {
            untrackedCount++;
          }
        });
      }
      
      return {
        missingCount: missingCount,
        mismatchCount: mismatchCount,
        untrackedCount: untrackedCount
      };
    }
    
    // Create spec comparison section for ordered fields
    function createSpecComparisonSection(sectionName, orderedFields, expectedSpecs, clientSpecs) {
      var sectionHtml = '<div class="mb-4">';
      sectionHtml += '<h6 class="text-primary">' + sectionName + '</h6>';
      sectionHtml += '<div class="table-responsive">';
      sectionHtml += '<table class="table table-striped table-hover table-sm config-comparison-table">';
      sectionHtml += '<thead class="table-dark"><tr><th class="config-field-col">Field</th><th class="config-client-col">Client</th><th class="config-expected-col">Expected</th></tr></thead>';
      sectionHtml += '<tbody>';
      
      // Show fields in the order provided
      if (orderedFields && Array.isArray(orderedFields)) {
        orderedFields.forEach(function(field) {
          if (field === 'BLOB_SCHEDULE') {
            // Handle blob schedule as special case
            sectionHtml += createBlobScheduleSpecRows(expectedSpecs, clientSpecs);
          } else {
            var expectedValue = expectedSpecs ? expectedSpecs[field] : undefined;
            var clientValue = clientSpecs ? clientSpecs[field] : undefined;
            
            sectionHtml += '<tr>';
            sectionHtml += '<td>';
            sectionHtml += '<strong>' + escapeHtml(field) + '</strong>';
            sectionHtml += '</td>';
            sectionHtml += '<td>' + formatSpecValue(clientValue, expectedValue) + '</td>';
            sectionHtml += '<td>' + formatSpecValue(expectedValue, true) + '</td>';
            sectionHtml += '</tr>';
          }
        });
      }
      
      sectionHtml += '</tbody></table></div></div>';
      return sectionHtml;
    }
    
    // Create untracked fields section
    function createUntrackedFieldsSection(expectedSpecs, clientSpecs) {
      var sectionHtml = '<div class="mb-4">';
      sectionHtml += '<h6 class="text-primary">Additional Untracked Fields</h6>';
      
      // Find additional fields that are only in client specs
      var additionalFields = [];
      if (clientSpecs) {
        Object.keys(clientSpecs).forEach(function(field) {
          // Skip fields that are in expected config, preset, or domain type fields
          var isInConfig = window.expectedConfigFields && window.expectedConfigFields.indexOf(field) !== -1;
          var isInPreset = window.expectedPresetFields && window.expectedPresetFields.indexOf(field) !== -1;
          var isInDomainTypes = window.expectedDomainTypeFields && window.expectedDomainTypeFields.indexOf(field) !== -1;
          var isInExpected = expectedSpecs && expectedSpecs.hasOwnProperty(field);
          
          if (!isInConfig && !isInPreset && !isInDomainTypes && !isInExpected) {
            additionalFields.push(field);
          }
        });
      }
      
      if (additionalFields.length === 0) {
        sectionHtml += '<div class="alert alert-info" role="alert">';
        sectionHtml += '<i class="fas fa-info-circle me-2"></i>';
        sectionHtml += 'No additional untracked fields found.';
        sectionHtml += '</div>';
        sectionHtml += '</div>';
        return sectionHtml;
      }
      
      sectionHtml += '<div class="table-responsive">';
      sectionHtml += '<table class="table table-striped table-hover table-sm config-comparison-table-2col">';
      sectionHtml += '<thead class="table-dark"><tr><th class="config-field-col-2">Field</th><th class="config-client-col-2">Client</th></tr></thead>';
      sectionHtml += '<tbody>';
      
      // Sort additional fields alphabetically
      additionalFields.sort();
      
      additionalFields.forEach(function(field) {
        var clientValue = clientSpecs ? clientSpecs[field] : undefined;
        
        sectionHtml += '<tr>';
        sectionHtml += '<td>';
        sectionHtml += '<strong>' + escapeHtml(field) + '</strong>';
        sectionHtml += '</td>';
        sectionHtml += '<td>' + formatSpecValue(clientValue, undefined) + '</td>';
        sectionHtml += '</tr>';
      });
      
      sectionHtml += '</tbody></table></div></div>';
      return sectionHtml;
    }
    
    // Create sub-rows for blob schedule
    function createBlobScheduleSpecRows(expectedSpecs, clientSpecs) {
      var html = '';
      
      var expectedSchedule = expectedSpecs ? expectedSpecs['BLOB_SCHEDULE'] : undefined;
      var clientSchedule = clientSpecs ? clientSpecs['BLOB_SCHEDULE'] : undefined;
      
      if (!expectedSchedule && !clientSchedule) return '';
      
      // Header row for blob schedule
      html += '<tr style="background-color: var(--bs-secondary-bg); border-top: 2px solid var(--bs-border-color);">';
      html += '<td><strong>üîπ BLOB_SCHEDULE</strong></td>';
      html += '<td colspan="2"><em>Blob schedule epochs and limits</em></td>';
      html += '</tr>';
      
      // Determine the longest schedule to iterate through
      var maxLength = 0;
      if (Array.isArray(expectedSchedule)) maxLength = Math.max(maxLength, expectedSchedule.length);
      if (Array.isArray(clientSchedule)) maxLength = Math.max(maxLength, clientSchedule.length);
      
      // Render entries in original order as specified
      for (var i = 0; i < maxLength; i++) {
        var expectedEntry = (Array.isArray(expectedSchedule) && i < expectedSchedule.length) ? expectedSchedule[i] : null;
        var clientEntry = (Array.isArray(clientSchedule) && i < clientSchedule.length) ? clientSchedule[i] : null;
        
        // Show EPOCH property
        var expectedEpoch = expectedEntry ? expectedEntry.EPOCH : undefined;
        var clientEpoch = clientEntry ? clientEntry.EPOCH : undefined;
        
        html += '<tr>';
        html += '<td style="padding-left: 2rem;">';
        html += '<span class="text-muted">‚îú‚îÄ</span> BPO' + (i+1) + ' EPOCH';
        html += '</td>';
        html += '<td>' + formatSpecValue(clientEpoch, expectedEpoch) + '</td>';
        html += '<td>' + formatSpecValue(expectedEpoch, true) + '</td>';
        html += '</tr>';
        
        // Show MAX_BLOBS_PER_BLOCK property
        var expectedBlobs = expectedEntry ? expectedEntry.MAX_BLOBS_PER_BLOCK : undefined;
        var clientBlobs = clientEntry ? clientEntry.MAX_BLOBS_PER_BLOCK : undefined;
        
        html += '<tr>';
        html += '<td style="padding-left: 2rem;">';
        html += '<span class="text-muted">‚îú‚îÄ</span> BPO' + (i+1) + ' MAX_BLOBS_PER_BLOCK';
        html += '</td>';
        html += '<td>' + formatSpecValue(clientBlobs, expectedBlobs) + '</td>';
        html += '<td>' + formatSpecValue(expectedBlobs, true) + '</td>';
        html += '</tr>';
      }
      
      return html;
    }

    function getNestedValue(obj, path) {
      if (!obj) return undefined;
      
      var value = obj;
      var parts = path.split('.');
      
      for (var i = 0; i < parts.length; i++) {
        if (value && typeof value === 'object') {
          value = value[parts[i]];
        } else {
          return undefined;
        }
      }
      
      return value;
    }

    function formatSpecValue(value, expectedValue) {
      if (value === undefined || value === null) {
        return '<span class="text-danger">N/A</span>';
      }
      
      // If expectedValue is boolean true, it means this is the expected column
      if (expectedValue === true) {
        if (typeof value === 'object') {
          if (Array.isArray(value)) {
            // Format byte arrays as hex
            if (value.length > 0 && typeof value[0] === 'number') {
              return '<code class="text-success">0x' + Array.prototype.map.call(value, function(byte) {
                return ('0' + (byte & 0xFF).toString(16)).slice(-2);
              }).join('') + '</code>';
            }
            // Format regular arrays
            return formatComplexValue(value, true);
          }
          // Format objects
          return formatComplexValue(value, true);
        }
        
        // Try to decode base64 to hex for strings that look like base64
        var formattedValue = formatBase64ToHex(value);
        return '<code class="text-success">' + escapeHtml(formattedValue) + '</code>';
      }
      
      // For client values, only show red if they don't match expected
      var cssClass = 'text-success';
      if (expectedValue !== undefined && !valuesMatch(value, expectedValue)) {
        cssClass = 'text-danger';
      } else if (expectedValue === undefined) {
        cssClass = 'text-muted';
      }
      
      if (typeof value === 'object') {
        if (Array.isArray(value)) {
          // Format byte arrays as hex
          if (value.length > 0 && typeof value[0] === 'number') {
            return '<code class="' + cssClass + '">0x' + Array.prototype.map.call(value, function(byte) {
              return ('0' + (byte & 0xFF).toString(16)).slice(-2);
            }).join('') + '</code>';
          }
          // Format regular arrays
          return formatComplexValue(value, cssClass);
        }
        // Format objects
        return formatComplexValue(value, cssClass);
      }
      
      // Try to decode base64 to hex for strings that look like base64
      var formattedValue = formatBase64ToHex(value);
      return '<code class="' + cssClass + '">' + escapeHtml(formattedValue) + '</code>';
    }
    
    // Convert base64 strings to hex format
    function formatBase64ToHex(value) {
      if (typeof value !== 'string') {
        return String(value);
      }
      
      // Check if it looks like base64 (length multiple of 4, valid base64 chars)
      if (value.length > 0 && value.length % 4 === 0 && /^[A-Za-z0-9+/]*={0,2}$/.test(value)) {
        try {
          // Try to decode base64
          var binaryString = atob(value);
          var hexString = '';
          for (var i = 0; i < binaryString.length; i++) {
            var hex = binaryString.charCodeAt(i).toString(16);
            hexString += (hex.length === 1 ? '0' : '') + hex;
          }
          
          // If we got a reasonable hex string, return it with 0x prefix
          if (hexString.length > 0) {
            return '0x' + hexString;
          }
        } catch (e) {
          // If base64 decode fails, just return original value
        }
      }
      
      return String(value);
    }
    
    function formatComplexValue(value, cssClass) {
      if (cssClass === true) cssClass = 'text-success';
      var formatted = '<div class="' + cssClass + '" style="font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto;">';
      formatted += escapeHtml(JSON.stringify(value, null, 2));
      formatted += '</div>';
      return formatted;
    }

    function escapeHtml(text) {
      if (text === undefined || text === null) {
        return '';
      }
      var map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
    }
  })();

  // Function to initialize peer collapse handlers for a specific container
  function initPeerCollapseHandlers(container) {
    container.find('.peer-details-collapse').on('show.bs.collapse', function () {
      $(this).siblings('.client-row-divider').find('.peer-collapse-btn').html('<i class="fa fa-chevron-up"></i> Hide Connected Peers');
    });

    container.find('.peer-details-collapse').on('hide.bs.collapse', function () {
      $(this).siblings('.client-row-divider').find('.peer-collapse-btn').html('<i class="fa fa-chevron-down"></i> Show Connected Peers');
    });
  }

  // PeerDAS accordion handler - render table only when opened
  var peerDASTableRendered = false;
  $('#collapseColumnInfos').on('shown.bs.collapse', function () {
    if (!peerDASTableRendered) {
      var template = $('#peerdas-table-template').html();
      $('#peerdas-table-container').html(template);
      
      // Initialize jdenticon for the newly added SVG elements
      jdenticon.update(".peer-table-icon", null);
      
      // Re-initialize all PeerDAS table interactions
      initializePeerDASTableInteractions();
      
      peerDASTableRendered = true;
    }
  });

  // Initialize PeerDAS table interactions (moved from inline)
  function initializePeerDASTableInteractions() {
    // PeerDASTable Hover
    let hoverTimeout;
    $('.dastablenode').hover(
      function() {
        hoverTimeout = setTimeout(() => {
          var searchText = $('#searchDASTablePeers').val();
          if(searchText) searchText = searchText.trim().toLowerCase();

          if (!searchText && lastClickedNode == null) {
            const $target = $(this);
            const selector = $target.attr('class').split(/\s+/).map(cls => cls!=""?'.' + cls:"").join('');
            $(selector).addClass('highlight');
            $('.dastablenode').addClass('blur');
          }
        }, 500);
      },
      function() {
        clearTimeout(hoverTimeout);
        var searchText = $('#searchDASTablePeers').val();
        if(searchText) searchText = searchText.trim().toLowerCase();

        if (!searchText && lastClickedNode == null) {
          const $target = $(this);
          const selector = $target.attr('class').split(/\s+/).map(cls => cls!=""?'.' + cls:"").join('');
          $(selector).removeClass('highlight');
          $('.dastablenode').removeClass('blur');
        }
      }
    );

    // PeerDASTable Click
    $('.dastablenode').on('click', function() {
      const $target = $(this);
      const selector = $target.attr('class').split(/\s+/).map(cls => '.' + cls).join('');
      const peerID = $target.data('peerid').toString();

      showPeerDetailsModal(peerID);

      // Remove highlight/blur from the last clicked node
      if (lastClickedNode != null) {
        $(lastClickedNode).removeClass('highlight');
        $('.dastablenode').removeClass('blur');
      }

      // Highlight clicked node and blur others
      $(selector).addClass('highlight');
      $('.dastablenode').not(selector).addClass('blur');

      // Store the clicked node
      lastClickedNode = selector;

      // Add node to searchtext
      $('#searchDASTablePeers').val(nodes[peerID].alias).trigger("input");
    });
  }

  // Function to toggle all peer info sections (right button)
  function toggleAllPeers() {
    var rightButton = $('#toggleAllPeers');
    var leftButton = $('#toggleNodeIds');
    var rightButtonText = rightButton.text();
    
    if (rightButtonText === 'Show all') {
      // Show all peer info sections
      $('.collapse.peerInfo').collapse('show');
      
      // Wait for the peer info sections to be shown, then show all connected peers
      setTimeout(function() {
        $('.peer-details-collapse').collapse('show');
      }, 500);
      
      // Right button: Show all -> Hide all
      rightButton.text('Hide all');
      // Left button: Expand node IDs -> Hide peers
      leftButton.text('Hide peers');
      leftButton.show();
    } else if (rightButtonText === 'Show peers') {
      // Show connected peers (peer info sections are already shown)
      $('.peer-details-collapse').collapse('show');
      
      // Right button: Show peers -> Hide all
      rightButton.text('Hide all');
      // Left button: Hide all node IDs -> Hide peers
      leftButton.text('Hide peers');
      leftButton.show();
    } else {
      // Hide all peer info sections
      $('.collapse.peerInfo').collapse('hide');
      
      // Right button: Hide all -> Show all
      rightButton.text('Show all');
      // Left button: Hide peers -> Expand node IDs
      leftButton.text('Expand node IDs');
      leftButton.show();
    }
  }

  // Function to toggle node IDs display (left button)
  function toggleNodeIds() {
    var leftButton = $('#toggleNodeIds');
    var rightButton = $('#toggleAllPeers');
    var leftButtonText = leftButton.text();
    
    if (leftButtonText === 'Expand node IDs') {
      // Show all peer info sections to reveal node identity details
      $('.collapse.peerInfo').collapse('show');
      
      // Wait for the peer info sections to be shown, then hide all connected peers
      setTimeout(function() {
        $('.peer-details-collapse').collapse('hide');
      }, 500);
      
      // Left button: Expand node IDs -> Hide all node IDs
      leftButton.text('Hide all node IDs');
      // Right button: Show all -> Show peers
      rightButton.text('Show peers');
    } else if (leftButtonText === 'Hide peers') {
      // Hide only the connected peers, keep node IDs visible
      $('.peer-details-collapse').collapse('hide');
      
      // Left button: Hide peers -> Hide all node IDs
      leftButton.text('Hide all node IDs');
      // Right button: Hide all -> Show peers
      rightButton.text('Show peers');
    } else {
      // Hide all peer info sections (Hide all node IDs)
      $('.collapse.peerInfo').collapse('hide');
      
      // Left button: Hide all node IDs -> Expand node IDs
      leftButton.text('Expand node IDs');
      // Right button: Show peers -> Show all
      rightButton.text('Show all');
    }
  }

  $(document).ready(function() {
    hashParams = new URLSearchParams(window.location.hash.substring(1))

    // DAS Guardian functionality
    let dasGuardianEnr = null;
    let selectedSlots = [];
    const fuluActivationEpoch = {{ .FuluActivationEpoch }};
    
    $('.das-check-btn').on('click', function() {
      dasGuardianEnr = $(this).data('enr');
      const clientName = $(this).data('client-name');
      
      // Update modal title
      $('#dasGuardianClientName').text(clientName);
      
      // Reset modal state
      $('#dasGuardianOptions').show();
      $('#dasGuardianLoading').hide();
      $('#dasGuardianResults').hide().empty();
      $('#slotSelectionSection').hide();
      $('#randomSlotSelectionSection').show(); // Show by default since random is now default
      $('#selectedSlotsList').empty();
      selectedSlots = [];
      
      // Reset form
      $('#scanRandomSlots').prop('checked', true); // Default to random slots
      $('#slotInput').val('');
      $('#randomWithBlobs').prop('checked', true); // Default to with_blobs
      $('#randomSlotCount').val('4');
      
      // Show modal
      $('#dasGuardianModal').modal('show');
    });
    
    // Handle scan type selection
    $('input[name="scanType"]').on('change', function() {
      const scanType = $(this).val();
      $('#slotSelectionSection').hide();
      $('#randomSlotSelectionSection').hide();
      
      if (scanType === 'slots') {
        $('#slotSelectionSection').show();
      } else if (scanType === 'random') {
        $('#randomSlotSelectionSection').show();
      }
    });
    
    // Add slot functionality
    $('#addSlotBtn').on('click', function() {
      const input = $('#slotInput').val().trim();
      if (!input) return;
      
      // Check if it's a slot number or root
      if (/^\d+$/.test(input)) {
        const slotNumber = parseInt(input);
        if (!selectedSlots.includes(slotNumber)) {
          selectedSlots.push(slotNumber);
          addSlotToList(slotNumber);
          $('#slotInput').val('');
        }
      } else if (/^0x[a-fA-F0-9]{64}$/.test(input)) {
        // It's a root, look up the slot
        $('#addSlotBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Looking up...');
        
        $.ajax({
          url: `/api/v1/slot/${input}`,
          method: 'GET',
          success: function(response) {
            if (response.data && !selectedSlots.includes(response.data.slot)) {
              selectedSlots.push(response.data.slot);
              addSlotToList(response.data.slot);
              $('#slotInput').val('');
            }
            $('#addSlotBtn').prop('disabled', false).html('<i class="fa-solid fa-plus"></i> Add Slot');
          },
          error: function() {
            alert('Block root not found');
            $('#addSlotBtn').prop('disabled', false).html('<i class="fa-solid fa-plus"></i> Add Slot');
          }
        });
      } else {
        alert('Please enter a valid slot number or block root (0x...)');
      }
    });
    
    // Handle enter key in slot input
    $('#slotInput').on('keypress', function(e) {
      if (e.which === 13) {
        $('#addSlotBtn').click();
      }
    });
    
    function addSlotToList(slot) {
      const slotElement = $(`
        <div class="slot-item border rounded p-2 mb-2" data-slot="${slot}">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>Slot ${slot.toLocaleString()}</strong>
              <span class="slot-info ms-2 text-muted">
                <i class="fas fa-spinner fa-spin"></i> Loading...
              </span>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" aria-label="Remove">
              <i class="fa-solid fa-times"></i>
            </button>
          </div>
        </div>
      `);
      
      slotElement.find('.btn-outline-danger').on('click', function() {
        selectedSlots = selectedSlots.filter(s => s !== slot);
        slotElement.remove();
      });
      
      $('#selectedSlotsList').append(slotElement);
      
      // Fetch slot info
      $.ajax({
        url: `/api/v1/slot/${slot}`,
        method: 'GET',
        success: function(response) {
          let infoHtml = '';
          
          // Check if slot is pre-Fulu (DAS not available)
          const slotEpoch = Math.floor(slot / 32);
          const isPreFulu = fuluActivationEpoch !== 18446744073709551615 && slotEpoch < fuluActivationEpoch; // 18446744073709551615 is max uint64 (never activated)
          
          if (response.data && response.data.status !== 'Missing') {
            infoHtml = `<span class="text-success"><i class="fa-solid fa-check"></i> Proposed</span>`;
            // Always display blob count (even when 0)
            const blobCount = response.data.blob_count || 0;
            infoHtml += ` | <span class="text-info">${blobCount} blob${blobCount !== 1 ? 's' : ''}</span>`;
            
            // Add pre-Fulu warning if applicable
            if (isPreFulu) {
              infoHtml += ` | <span class="text-warning"><i class="fa-solid fa-exclamation-triangle"></i> Pre-Fulu (DAS not available)</span>`;
            }
          } else {
            infoHtml = `<span class="text-warning"><i class="fa-solid fa-times"></i> Not proposed</span>`;
            // Add pre-Fulu warning for missing blocks too
            if (isPreFulu) {
              infoHtml += ` | <span class="text-warning"><i class="fa-solid fa-exclamation-triangle"></i> Pre-Fulu (DAS not available)</span>`;
            }
          }
          slotElement.find('.slot-info').html(infoHtml);
        },
        error: function() {
          slotElement.find('.slot-info').html('<span class="text-danger"><i class="fa-solid fa-exclamation-triangle"></i> Error loading</span>');
        }
      });
    }
    
    // Start scan button
    $('#startScanBtn').on('click', function() {
      const scanType = $('input[name="scanType"]:checked').val();
      
      if (scanType === 'slots' && selectedSlots.length === 0) {
        alert('Please select at least one slot to scan');
        return;
      }
      
      // Hide options, show loading
      $('#dasGuardianOptions').hide();
      $('#dasGuardianLoading').show();
      
      // Prepare request data
      const requestData = { enr: dasGuardianEnr };
      if (scanType === 'slots') {
        requestData.slots = selectedSlots;
      } else if (scanType === 'random') {
        const randomMode = $('input[name="randomMode"]:checked').val();
        const randomCount = parseInt($('#randomSlotCount').val()) || 4;
        requestData.random_mode = randomMode;
        requestData.random_count = randomCount;
      }
      
      // Make API call
      $.ajax({
        url: '/api/v1/das-guardian/scan',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(requestData),
        success: function(response) {
          $('#dasGuardianLoading').hide();
          displayDasGuardianResults(response);
        },
        error: function(xhr) {
          $('#dasGuardianLoading').hide();
          let errorMsg = 'Failed to run DAS Guardian scan';
          try {
            const errorData = JSON.parse(xhr.responseText);
            if (errorData.error) errorMsg = errorData.error;
          } catch (e) {}
          displayDasGuardianError(errorMsg);
        }
      });
    });

    function displayDasGuardianResults(data) {
      const $results = $('#dasGuardianResults');
      
      let html = '';
      
      // Handle error case
      if (data.error && !data.result) {
        html = `<div class="alert alert-danger" role="alert">
          <h5><i class="fa-solid fa-triangle-exclamation"></i> Error</h5>
          <p>${escapeHtml(data.error)}</p>
        </div>`;
        $results.html(html).show();
        return;
      }
      
      // Display results even if there was an error (partial results)
      if (data.result) {
        const result = data.result;
        
        // P2P Information Section
        if (result.libp2p_info && Object.keys(result.libp2p_info).length > 0) {
          html += `<div class="mb-4">
            <h6 class="border-bottom pb-2"><i class="fa-solid fa-network-wired"></i> P2P Information</h6>
            <table class="table table-sm">
              <tbody>`;
          
          // Extract specific fields from libp2p_info
          if (result.libp2p_info.peer_id) {
            html += `<tr><td><strong>Peer ID:</strong></td><td><code>${escapeHtml(result.libp2p_info.peer_id)}</code></td></tr>`;
          }
          if (result.libp2p_info.user_agent) {
            html += `<tr><td><strong>User Agent:</strong></td><td>${escapeHtml(result.libp2p_info.user_agent)}</td></tr>`;
          }
          if (result.libp2p_info.protocol_version) {
            html += `<tr><td><strong>Protocol Version:</strong></td><td>${escapeHtml(result.libp2p_info.protocol_version)}</td></tr>`;
          }
          if (result.libp2p_info.ping_rtt) {
            html += `<tr><td><strong>Ping RTT:</strong></td><td>${escapeHtml(result.libp2p_info.ping_rtt)}</td></tr>`;
          }
          if (result.libp2p_info.multiaddresses && Array.isArray(result.libp2p_info.multiaddresses)) {
            html += `<tr><td><strong>Addresses:</strong></td><td>${result.libp2p_info.multiaddresses.map(addr => `<code>${escapeHtml(addr)}</code>`).join('<br>')}</td></tr>`;
          }
          if (result.libp2p_info.protocols && Array.isArray(result.libp2p_info.protocols)) {
            html += `<tr><td><strong>Protocols:</strong></td><td><small>${result.libp2p_info.protocols.map(p => `<code>${escapeHtml(p)}</code>`).join(' ')}</small></td></tr>`;
          }
          
          html += `</tbody></table></div>`;
        }
        
        // Status Information Section  
        if (result.remote_status) {
          const status = result.remote_status;
          const localForkDigest = '{{ printf "0x%x" .CurrentForkDigest }}';
          const forkDigestValid = status.fork_digest === localForkDigest;
          
          html += `<div class="mb-4">
            <h6 class="border-bottom pb-2"><i class="fa-solid fa-signal"></i> Beacon Status</h6>
            <table class="table table-sm">
              <tbody>
                <tr>
                  <td><strong>Fork Digest:</strong></td>
                  <td>
                    <code>${escapeHtml(status.fork_digest)}</code>
                    ${forkDigestValid ? 
                      '<span class="badge bg-success ms-2"><i class="fa-solid fa-check"></i> Valid</span>' : 
                      '<span class="badge bg-danger ms-2"><i class="fa-solid fa-times"></i> Invalid</span>'}
                  </td>
                </tr>
                <tr>
                  <td><strong>Head Slot:</strong></td>
                  <td><a href="/slot/${status.head_slot}">${status.head_slot.toLocaleString()}</a></td>
                </tr>
                <tr>
                  <td><strong>Head Root:</strong></td>
                  <td><code class="text-truncate d-inline-block" style="max-width: 400px">${escapeHtml(status.head_root)}</code></td>
                </tr>
                <tr>
                  <td><strong>Finalized Epoch:</strong></td>
                  <td><a href="/epoch/${status.finalized_epoch}">${status.finalized_epoch.toLocaleString()}</a></td>
                </tr>
                <tr>
                  <td><strong>Finalized Root:</strong></td>
                  <td><code class="text-truncate d-inline-block" style="max-width: 400px">${escapeHtml(status.finalized_root)}</code></td>
                </tr>`;
          
          // Add earliest_available_slot if available (statusv2 only)
          if (status.earliest_slot !== undefined) {
            html += `<tr>
                  <td><strong>Earliest Available Slot:</strong></td>
                  <td><a href="/slot/${status.earliest_slot}">${status.earliest_slot.toLocaleString()}</a></td>
                </tr>`;
          }
          
          html += `</tbody>
            </table>
          </div>`;
        }
        
        // Metadata Section
        if (result.remote_metadata) {
          const metadata = result.remote_metadata;
          html += `<div class="mb-4">
            <h6 class="border-bottom pb-2"><i class="fa-solid fa-info-circle"></i> Node Metadata</h6>
            <table class="table table-sm">
              <tbody>
                <tr><td><strong>Sequence Number:</strong></td><td>${metadata.seq_number}</td></tr>
                <tr><td><strong>Attnets:</strong></td><td><code>${escapeHtml(metadata.attnets)}</code></td></tr>
                <tr><td><strong>Syncnets:</strong></td><td><code>${escapeHtml(metadata.syncnets)}</code></td></tr>
                <tr><td><strong>Custody Group Count:</strong></td><td>${metadata.custody_group_count}</td></tr>
              </tbody>
            </table>
          </div>`;
        }
        
        // DAS Evaluation Results
        if (result.eval_result) {
          const evalResult = result.eval_result;
          html += `<div class="mb-4">
            <h6 class="border-bottom pb-2"><i class="fa-solid fa-database"></i> DAS Custody Check</h6>`;
          
          if (evalResult.error) {
            html += `<div class="alert alert-warning"><i class="fa-solid fa-triangle-exclamation"></i> ${escapeHtml(evalResult.error)}</div>`;
          }
          
          if (evalResult.node_id) {
            html += `<p><strong>Node ID:</strong> <code>${escapeHtml(evalResult.node_id)}</code></p>`;
          }
          
          if (evalResult.column_idx && evalResult.column_idx.length > 0) {
            html += `<p><strong>Custody Columns:</strong> ${evalResult.column_idx.map(idx => `<span class="badge bg-primary">${idx}</span>`).join(' ')}</p>`;
          }
          
          // Display slot validation results
          if (evalResult.slots && evalResult.slots.length > 0) {
            html += `<div class="table-responsive">
              <table class="table table-sm table-bordered">
                <thead>
                  <tr>
                    <th>Slot</th>
                    <th>Status</th>
                    <th>Column Validation</th>
                  </tr>
                </thead>
                <tbody>`;
            
            for (let i = 0; i < evalResult.slots.length; i++) {
              const slot = evalResult.slots[i];
              const isValid = evalResult.valid_slot && evalResult.valid_slot[i];
              const columnValidation = evalResult.valid_column && evalResult.valid_column[i];
              
              html += `<tr>
                <td><a href="/slot/${slot}">${slot.toLocaleString()}</a></td>
                <td>${isValid ? '<span class="badge bg-success">Valid</span>' : '<span class="badge bg-danger">Invalid</span>'}</td>
                <td>`;
              
              if (columnValidation) {
                const validCount = columnValidation.filter(v => v).length;
                const totalCount = columnValidation.length;
                html += `<span class="badge ${validCount === totalCount ? 'bg-success' : validCount > 0 ? 'bg-warning' : 'bg-danger'}">${validCount}/${totalCount} valid</span>`;
              }
              
              html += `</td></tr>`;
            }
            
            html += `</tbody></table></div>`;
          }
          
          html += `</div>`;
        }
        
        // Show error at the bottom if there was one along with partial results
        if (data.error) {
          html += `<div class="alert alert-warning" role="alert">
            <h6><i class="fa-solid fa-triangle-exclamation"></i> Partial Results</h6>
            <p class="mb-0">The scan completed with some errors. The information above shows all data that could be retrieved.</p>
            <p class="mb-0"><strong>Error:</strong> ${escapeHtml(data.error)}</p>
          </div>`;
        }
      }
      
      $results.html(html).show();
    }

    function displayDasGuardianError(error) {
      const html = `<div class="alert alert-danger" role="alert">
        <h5><i class="fa-solid fa-triangle-exclamation"></i> Error</h5>
        <p>${escapeHtml(error)}</p>
      </div>`;
      $('#dasGuardianResults').html(html).show();
    }

    function escapeHtml(text) {
      if (!text) return '';
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.toString().replace(/[&<>"']/g, m => map[m]);
    }

    // Reset function for mass DAS Guardian modal (called from onclick)
    function resetMassDasGuardianModal() {
      // Reset modal state
      $('#massDasGuardianSlotSelection').show();
      $('#massDasGuardianLoading').hide();
      $('#massDasGuardianResults').hide().empty();
      $('#massSpecificSlotSection').hide();
      $('#massRandomSlotSection').show();
      $('#massSelectedSlotsList').empty();
      massSelectedSlots = [];
      
      // Reset form
      $('#massRandomSlots').prop('checked', true);
      $('#massRandomWithBlobs').prop('checked', true);
      $('#massRandomSlotCount').val('4');
      $('#massSlotInput').val('');
      
      // Show modal
      $('#massDasGuardianModal').modal('show');
    }

    // Mass DAS Guardian functionality
    let massSelectedSlots = [];
    
    $('#massDasGuardianBtn').on('click', function() {
      // Reset modal state
      $('#massDasGuardianSlotSelection').show();
      $('#massDasGuardianLoading').hide();
      $('#massDasGuardianResults').hide().empty();
      $('#massSpecificSlotSection').hide();
      $('#massRandomSlotSection').show();
      $('#massSelectedSlotsList').empty();
      massSelectedSlots = [];
      
      // Reset form
      $('#massRandomSlots').prop('checked', true);
      $('#massRandomWithBlobs').prop('checked', true);
      $('#massRandomSlotCount').val('4');
      $('#massSlotInput').val('');
      
      // Show modal
      $('#massDasGuardianModal').modal('show');
    });
    
    // Handle mass scan type selection
    $('input[name="massScanType"]').on('change', function() {
      const scanType = $(this).val();
      $('#massRandomSlotSection').hide();
      $('#massSpecificSlotSection').hide();
      
      if (scanType === 'random') {
        $('#massRandomSlotSection').show();
      } else if (scanType === 'slots') {
        $('#massSpecificSlotSection').show();
      }
    });
    
    // Mass scan specific slot functionality
    $('#massAddSlotBtn').on('click', function() {
      const input = $('#massSlotInput').val().trim();
      if (!input) return;
      
      // Check if it's a slot number or root
      if (/^\d+$/.test(input)) {
        const slotNumber = parseInt(input);
        if (!massSelectedSlots.includes(slotNumber)) {
          massSelectedSlots.push(slotNumber);
          addMassSlotToList(slotNumber);
          $('#massSlotInput').val('');
        }
      } else if (/^0x[a-fA-F0-9]{64}$/.test(input)) {
        // It's a root, look up the slot
        $('#massAddSlotBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Looking up...');
        
        $.ajax({
          url: `/api/v1/slot/${input}`,
          method: 'GET',
          success: function(response) {
            if (response.data && !massSelectedSlots.includes(response.data.slot)) {
              massSelectedSlots.push(response.data.slot);
              addMassSlotToList(response.data.slot);
              $('#massSlotInput').val('');
            }
            $('#massAddSlotBtn').prop('disabled', false).html('<i class="fa-solid fa-plus"></i> Add Slot');
          },
          error: function() {
            alert('Block root not found');
            $('#massAddSlotBtn').prop('disabled', false).html('<i class="fa-solid fa-plus"></i> Add Slot');
          }
        });
      } else {
        alert('Please enter a valid slot number or block root (0x...)');
      }
    });
    
    // Handle enter key in mass slot input
    $('#massSlotInput').on('keypress', function(e) {
      if (e.which === 13) {
        $('#massAddSlotBtn').click();
      }
    });
    
    function addMassSlotToList(slot) {
      const slotElement = $(`
        <div class="slot-item border rounded p-2 mb-2" data-slot="${slot}">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>Slot ${slot.toLocaleString()}</strong>
              <span class="slot-info ms-2 text-muted">
                <i class="fas fa-spinner fa-spin"></i> Loading...
              </span>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" aria-label="Remove">
              <i class="fa-solid fa-times"></i>
            </button>
          </div>
        </div>
      `);
      
      slotElement.find('.btn-outline-danger').on('click', function() {
        massSelectedSlots = massSelectedSlots.filter(s => s !== slot);
        slotElement.remove();
      });
      
      $('#massSelectedSlotsList').append(slotElement);
      
      // Fetch slot info (reuse the existing function logic)
      $.ajax({
        url: `/api/v1/slot/${slot}`,
        method: 'GET',
        success: function(response) {
          let infoHtml = '';
          
          // Check if slot is pre-Fulu (DAS not available)
          const slotEpoch = Math.floor(slot / 32);
          const isPreFulu = fuluActivationEpoch !== 18446744073709551615 && slotEpoch < fuluActivationEpoch;
          
          if (response.data && response.data.status !== 'Missing') {
            infoHtml = `<span class="text-success"><i class="fa-solid fa-check"></i> Proposed</span>`;
            // Always display blob count (even when 0)
            const blobCount = response.data.blob_count || 0;
            infoHtml += ` | <span class="text-info">${blobCount} blob${blobCount !== 1 ? 's' : ''}</span>`;
            
            // Add pre-Fulu warning if applicable
            if (isPreFulu) {
              infoHtml += ` | <span class="text-warning"><i class="fa-solid fa-exclamation-triangle"></i> Pre-Fulu (DAS not available)</span>`;
            }
          } else {
            infoHtml = `<span class="text-warning"><i class="fa-solid fa-times"></i> Not proposed</span>`;
            // Add pre-Fulu warning for missing blocks too
            if (isPreFulu) {
              infoHtml += ` | <span class="text-warning"><i class="fa-solid fa-exclamation-triangle"></i> Pre-Fulu (DAS not available)</span>`;
            }
          }
          slotElement.find('.slot-info').html(infoHtml);
        },
        error: function() {
          slotElement.find('.slot-info').html('<span class="text-danger"><i class="fa-solid fa-exclamation-triangle"></i> Error loading</span>');
        }
      });
    }
    
    // Start mass scan functionality
    $('#startMassScanBtn').on('click', function() {
      const scanType = $('input[name="massScanType"]:checked').val();
      
      if (scanType === 'slots' && massSelectedSlots.length === 0) {
        alert('Please select at least one slot to scan');
        return;
      }
      
      // Hide slot selection, show loading
      $('#massDasGuardianSlotSelection').hide();
      $('#massDasGuardianLoading').show();
      $('#massProgressBar').css('width', '0%');
      $('#massProgressText').text('Initializing...');
      
      // Prepare request data
      const requestData = { mass_scan: true };
      if (scanType === 'slots') {
        requestData.slots = massSelectedSlots;
      } else {
        // Random mode
        const randomMode = $('input[name="massRandomMode"]:checked').val();
        const randomCount = parseInt($('#massRandomSlotCount').val()) || 4;
        requestData.random_mode = randomMode;
        requestData.random_count = randomCount;
      }
      
      // Make API call
      $.ajax({
        url: '/api/v1/das-guardian/mass-scan',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(requestData),
        success: function(response) {
          $('#massDasGuardianLoading').hide();
          displayMassDasGuardianResults(response);
        },
        error: function(xhr) {
          $('#massDasGuardianLoading').hide();
          let errorMsg = 'Failed to run mass DAS Guardian scan';
          try {
            const errorData = JSON.parse(xhr.responseText);
            if (errorData.error) errorMsg = errorData.error;
          } catch (e) {}
          displayMassDasGuardianError(errorMsg);
        }
      });
    });
    
    function displayMassDasGuardianResults(data) {
      const $results = $('#massDasGuardianResults');
      
      if (data.error && !data.results) {
        displayMassDasGuardianError(data.error);
        return;
      }
      
      // Create results grid: slots as columns, nodes as rows
      let html = '<div class="table-responsive"><table class="table table-sm table-bordered table-striped mass-das-results-table"><thead class="table-dark"><tr>';
      html += '<th class="mass-das-node-col">Node</th>';
      html += '<th class="text-center mass-das-cgc-col">CGC</th>';
      html += '<th class="text-center mass-das-earliest-col">Earliest Slot</th>';
      
      // Add slot columns
      const slots = data.slots || [];
      slots.forEach(slot => {
        html += `<th class="text-center mass-das-slot-col">Slot ${slot.toLocaleString()}</th>`;
      });
      html += '</tr></thead><tbody>';
      
      // Add node rows (sorted by node name)
      const results = data.results || {};
      const sortedNodeEnrs = Object.keys(results).sort((a, b) => {
        const nodeA = results[a].node_alias || a.substring(0, 20) + '...';
        const nodeB = results[b].node_alias || b.substring(0, 20) + '...';
        return nodeA.localeCompare(nodeB);
      });
      
      sortedNodeEnrs.forEach(nodeEnr => {
        const nodeResult = results[nodeEnr];
        const nodeName = nodeResult.node_alias || nodeEnr.substring(0, 20) + '...';
        
        html += `<tr><td class="mass-das-node-col"><strong>${escapeHtml(nodeName)}</strong><small class="text-muted">${escapeHtml(nodeEnr.substring(0, 30))}...</small></td>`;
        // Format custody columns for tooltip
        const custodyColumns = nodeResult.custody_columns || [];
        const custodyColumnsText = custodyColumns.length > 0 ? custodyColumns.join(', ') : 'No custody columns available';
        const cgcDisplay = nodeResult.custody_group_count || '-';
        
        html += `<td class="text-center mass-das-cgc-col" data-bs-toggle="tooltip" data-bs-placement="top" title="Custody columns: ${custodyColumnsText}" style="cursor: ${custodyColumns.length > 0 ? 'help' : 'default'}">${cgcDisplay}</td>`;
        html += `<td class="text-center mass-das-earliest-col">${nodeResult.earliest_slot ? nodeResult.earliest_slot.toLocaleString() : '-'}</td>`;
        
        slots.forEach(slot => {
          const slotResult = nodeResult.slot_results && nodeResult.slot_results[slot];
          if (slotResult) {
            if (slotResult.error) {
              // Slot-specific error
              html += `<td class="text-center mass-das-slot-col"><span class="badge bg-danger" data-bs-toggle="tooltip" data-bs-placement="top" title="${escapeHtml(slotResult.error)}" style="cursor: help">Error</span></td>`;
            } else {
              // Normal slot result
              const validColumns = slotResult.valid_column_count || 0;
              const totalColumns = slotResult.total_columns || 0;
              const percentage = totalColumns > 0 ? Math.round((validColumns / totalColumns) * 100) : 0;
              
              let badgeClass = 'bg-danger';
              if (percentage >= 90) badgeClass = 'bg-success';
              else if (percentage >= 50) badgeClass = 'bg-warning';
              
              html += `<td class="text-center mass-das-slot-col"><span class="badge ${badgeClass}">${validColumns}/${totalColumns}</span><br><small class="text-muted">(${percentage}%)</small></td>`;
            }
          } else if (nodeResult.error) {
            // Node-level error
            html += `<td class="text-center mass-das-slot-col"><span class="badge bg-danger" data-bs-toggle="tooltip" data-bs-placement="top" title="${escapeHtml(nodeResult.error)}" style="cursor: help">Error</span></td>`;
          } else {
            // No data available
            html += '<td class="text-center mass-das-slot-col"><span class="badge bg-secondary">-</span></td>';
          }
        });
        html += '</tr>';
      });
      
      html += '</tbody></table></div>';
      
      if (data.error) {
        html += `<div class="alert alert-warning mt-3">
          <h6><i class="fa-solid fa-triangle-exclamation"></i> Partial Results</h6>
          <p class="mb-0">Some scans completed with errors. The table above shows all available data.</p>
          <p class="mb-0"><strong>Error:</strong> ${escapeHtml(data.error)}</p>
        </div>`;
      }
      
      $results.html(html).show();
      
      // Initialize Bootstrap tooltips for custody columns and errors
      $results.find('[data-bs-toggle="tooltip"]').tooltip({
        container: 'body', // Render tooltips in body to avoid z-index issues
        boundary: 'viewport' // Keep tooltips within viewport
      });
    }
    
    function displayMassDasGuardianError(error) {
      const html = `<div class="alert alert-danger" role="alert">
        <h5><i class="fa-solid fa-triangle-exclamation"></i> Error</h5>
        <p>${escapeHtml(error)}</p>
      </div>`;
      $('#massDasGuardianResults').html(html).show();
    }
    
    if (hashParams.has("name")) {
      name = hashParams.get("name")
      clientRow = $("#clientRow-" + name)
      if (clientRow) {
        clientRow.click()
      }
    }
    
    // Check refresh cooldown status on page load
    if (typeof window.explorer !== 'undefined' && window.explorer.checkRefreshCooldown) {
      window.explorer.checkRefreshCooldown();
    }
  });
</script>
{{ end }}
{{ define "css" }}
<link rel="stylesheet" href="/css/clients.css" />
<style>
#toggleAllPeers, #toggleNodeIds {
  min-width: 140px;
  width: 140px;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Mass DAS Guardian results table column sizing */
.mass-das-results-table .mass-das-node-col {
  width: 200px;
  min-width: 180px;
  max-width: 220px;
  vertical-align: top;
}

.mass-das-results-table .mass-das-node-col strong {
  display: block;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
  line-height: 1.2;
}

.mass-das-results-table .mass-das-node-col small {
  display: block;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
  line-height: 1.1;
}

.mass-das-results-table .mass-das-cgc-col {
  width: 80px;
  min-width: 70px;
  max-width: 90px;
}

.mass-das-results-table .mass-das-earliest-col,
.mass-das-results-table .mass-das-slot-col {
  width: 120px;
  min-width: 100px;
  max-width: 140px;
}

/* Ensure consistent row height */
.mass-das-results-table tbody tr {
  height: 60px;
}

.mass-das-results-table tbody td {
  vertical-align: middle;
  padding: 8px;
}

/* Override vertical alignment for node column to top */
.mass-das-results-table .mass-das-node-col {
  vertical-align: top !important;
  padding-top: 8px;
}

/* Make mass DAS Guardian modal extra wide */
.mass-das-modal-extra-wide {
  max-width: 95vw;
}

@media (min-width: 1200px) {
  .mass-das-modal-extra-wide {
    max-width: 90vw;
  }
}

@media (min-width: 1400px) {
  .mass-das-modal-extra-wide {
    max-width: 85vw;
  }
}

/* Fix tooltip z-index to appear above modals */
.tooltip {
  z-index: 9999 !important;
}

/* Ensure Bootstrap tooltips appear above modals */
.bs-tooltip-top, .bs-tooltip-bottom, .bs-tooltip-start, .bs-tooltip-end {
  z-index: 9999 !important;
}

/* Spec mismatch icon styling */
.spec-mismatch-icon {
  cursor: pointer;
  margin-left: 5px;
}

.spec-mismatch-icon:hover {
  opacity: 0.8;
}

/* Spec mismatch modal table styling */
#specMismatchModal .table td {
  vertical-align: middle;
}

#specMismatchModal .table code {
  word-break: break-all;
}
</style>
{{ end }}
